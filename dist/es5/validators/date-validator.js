"use strict";
var moment = require('moment');
var _ = require('lodash');
var composed_validation_result_1 = require('../composed-validation-result');
var cleaned_1 = require('../cleaned');
var DateValidator = (function () {
    function DateValidator() {
    }
    DateValidator.getValidatorsForKey = function (key, definition, options, object) {
        var validators = {
            type: cleaned_1.cleaned(DateValidator.RULES.type, key, definition, options)
        };
        if (definition.before) {
            _.assign(validators, cleaned_1.cleaned(DateValidator.RULES.before, key, definition, options));
        }
        if (definition.after) {
            _.assign(validators, cleaned_1.cleaned(DateValidator.RULES.after, key, definition, options));
        }
        return validators;
    };
    DateValidator.prototype.validate = function (key, definition, value, options) {
        var result = new composed_validation_result_1.ComposedValidationResult();
        var rules = DateValidator.RULES;
        result.and(rules.type(value, key, definition));
        if (result.isValid()) {
            result.and(rules.before(value, key, definition));
            result.and(rules.after(value, key, definition));
        }
        return result;
    };
    DateValidator.prototype.clean = function (definition, value, options, object) {
        if (!options.autoConvert) {
            return value;
        }
        if (typeof value === 'string') {
            if (typeof definition.dateFormat === 'string') {
                return moment(value, definition.dateFormat).toDate();
            }
            else {
                return moment(value).toDate();
            }
        }
        return value;
    };
    DateValidator.RULES = {
        type: function (value, key, definition) {
            if ((typeof value !== 'undefined' && value !== null) && !(value instanceof Date)) {
                return {
                    property: key,
                    rule: 'type',
                    message: "Property " + key + " must be of type Date"
                };
            }
            return null;
        },
        before: function (value, key, definition) {
            if ((typeof value !== 'undefined' && value !== null) && (definition.before instanceof Date) && !moment(value).isBefore(definition.before)) {
                return {
                    property: key,
                    rule: 'type',
                    message: "Property " + key + " must be a date before " + definition.before
                };
            }
            return null;
        },
        after: function (value, key, definition) {
            if ((typeof value !== 'undefined' && value !== null) && (definition.after instanceof Date) && !moment(value).isAfter(definition.after)) {
                return {
                    property: key,
                    rule: 'type',
                    message: "Property " + key + " must be a date after " + definition.after
                };
            }
            return null;
        }
    };
    return DateValidator;
}());
exports.DateValidator = DateValidator;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInZhbGlkYXRvcnMvZGF0ZS12YWxpZGF0b3IudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLElBQVksTUFBTSxXQUFNLFFBQ3hCLENBQUMsQ0FEK0I7QUFDaEMsSUFBWSxDQUFDLFdBQU0sUUFFbkIsQ0FBQyxDQUYwQjtBQVMzQiwyQ0FBeUMsK0JBQ3pDLENBQUMsQ0FEdUU7QUFDeEUsd0JBQXdCLFlBRXhCLENBQUMsQ0FGbUM7QUFFcEM7SUFBQTtJQTZFQSxDQUFDO0lBMUNpQixpQ0FBbUIsR0FBakMsVUFBa0MsR0FBVyxFQUFFLFVBQWdDLEVBQUUsT0FBMEIsRUFBRSxNQUFZO1FBQ3JILElBQU0sVUFBVSxHQUFRO1lBQ3BCLElBQUksRUFBRSxpQkFBTyxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLEdBQUcsRUFBRSxVQUFVLEVBQUUsT0FBTyxDQUFDO1NBQ3BFLENBQUE7UUFFRCxFQUFFLENBQUMsQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztZQUNwQixDQUFDLENBQUMsTUFBTSxDQUFDLFVBQVUsRUFBRSxpQkFBTyxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsTUFBTSxFQUFFLEdBQUcsRUFBRSxVQUFVLEVBQUUsT0FBTyxDQUFDLENBQUMsQ0FBQTtRQUN2RixDQUFDO1FBRUQsRUFBRSxDQUFDLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7WUFDbkIsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxVQUFVLEVBQUUsaUJBQU8sQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLEtBQUssRUFBRSxHQUFHLEVBQUUsVUFBVSxFQUFFLE9BQU8sQ0FBQyxDQUFDLENBQUE7UUFDdEYsQ0FBQztRQUVELE1BQU0sQ0FBQyxVQUFVLENBQUE7SUFDckIsQ0FBQztJQUVELGdDQUFRLEdBQVIsVUFBUyxHQUFXLEVBQUUsVUFBZ0MsRUFBRSxLQUFVLEVBQUUsT0FBMEI7UUFDMUYsSUFBTSxNQUFNLEdBQUcsSUFBSSxxREFB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SUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDckksTUFBTSxDQUFDO29CQUNILFFBQVEsRUFBRSxHQUFHO29CQUNiLElBQUksRUFBRSxNQUFNO29CQUNaLE9BQU8sRUFBRSxjQUFZLEdBQUcsOEJBQXlCLFVBQVUsQ0FBQyxLQUFPO2lCQUN0RSxDQUFBO1lBQ0wsQ0FBQztZQUNELE1BQU0sQ0FBQyxJQUFJLENBQUE7UUFDZixDQUFDO0tBQ0osQ0FBQTtJQTRDTCxvQkFBQztBQUFELENBN0VBLEFBNkVDLElBQUE7QUE3RVkscUJBQWEsZ0JBNkV6QixDQUFBIiwiZmlsZSI6InZhbGlkYXRvcnMvZGF0ZS12YWxpZGF0b3IuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBtb21lbnQgZnJvbSAnbW9tZW50J1xuaW1wb3J0ICogYXMgXyBmcm9tICdsb2Rhc2gnXG5cbmltcG9ydCB7XG4gICAgVmFsaWRhdG9yLFxuICAgIFZhbGlkYXRpb25EZWZpbml0aW9uLFxuICAgIFZhbGlkYXRpb25SZXN1bHQsXG4gICAgVmFsaWRhdGlvbk9wdGlvbnMsXG4gICAgQ2xlYW5PcHRpb25zXG59ICBmcm9tICcuLi9pbnRlcmZhY2VzJ1xuaW1wb3J0IHsgQ29tcG9zZWRWYWxpZGF0aW9uUmVzdWx0IH0gZnJvbSAnLi4vY29tcG9zZWQtdmFsaWRhdGlvbi1yZXN1bHQnXG5pbXBvcnQgeyBjbGVhbmVkIH0gZnJvbSAnLi4vY2xlYW5lZCdcblxuZXhwb3J0IGNsYXNzIERhdGVWYWxpZGF0b3IgaW1wbGVtZW50cyBWYWxpZGF0b3Ige1xuXG4gICAgIHB1YmxpYyBzdGF0aWMgUlVMRVMgPSB7XG4gICAgICAgIHR5cGU6ICh2YWx1ZTogYW55LCBrZXk6IHN0cmluZywgZGVmaW5pdGlvbjogVmFsaWRhdGlvbkRlZmluaXRpb24pID0+IHtcbiAgICAgICAgICAgIGlmICgodHlwZW9mIHZhbHVlICE9PSAndW5kZWZpbmVkJyAmJiB2YWx1ZSAhPT0gbnVsbCkgJiYgISh2YWx1ZSBpbnN0YW5jZW9mIERhdGUpKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICAgICAgcHJvcGVydHk6IGtleSxcbiAgICAgICAgICAgICAgICAgICAgcnVsZTogJ3R5cGUnLFxuICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiBgUHJvcGVydHkgJHtrZXl9IG11c3QgYmUgb2YgdHlwZSBEYXRlYFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBudWxsXG4gICAgICAgIH0sXG4gICAgICAgIGJlZm9yZTogKHZhbHVlOiBhbnksIGtleTogc3RyaW5nLCBkZWZpbml0aW9uOiBWYWxpZGF0aW9uRGVmaW5pdGlvbikgPT4ge1xuICAgICAgICAgICAgaWYgKCh0eXBlb2YgdmFsdWUgIT09ICd1bmRlZmluZWQnICYmIHZhbHVlICE9PSBudWxsKSAmJiAoZGVmaW5pdGlvbi5iZWZvcmUgaW5zdGFuY2VvZiBEYXRlKSAmJiAhbW9tZW50KHZhbHVlKS5pc0JlZm9yZShkZWZpbml0aW9uLmJlZm9yZSkpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgICAgICBwcm9wZXJ0eToga2V5LFxuICAgICAgICAgICAgICAgICAgICBydWxlOiAndHlwZScsXG4gICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IGBQcm9wZXJ0eSAke2tleX0gbXVzdCBiZSBhIGRhdGUgYmVmb3JlICR7ZGVmaW5pdGlvbi5iZWZvcmV9YFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBudWxsXG4gICAgICAgIH0sXG4gICAgICAgIGFmdGVyOiAodmFsdWU6IGFueSwga2V5OiBzdHJpbmcsIGRlZmluaXRpb246IFZhbGlkYXRpb25EZWZpbml0aW9uKSA9PiB7XG4gICAgICAgICAgICBpZiAoKHR5cGVvZiB2YWx1ZSAhPT0gJ3VuZGVmaW5lZCcgJiYgdmFsdWUgIT09IG51bGwpICYmIChkZWZpbml0aW9uLmFmdGVyIGluc3RhbmNlb2YgRGF0ZSkgJiYgIW1vbWVudCh2YWx1ZSkuaXNBZnRlcihkZWZpbml0aW9uLmFmdGVyKSkge1xuICAgICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgICAgIHByb3BlcnR5OiBrZXksXG4gICAgICAgICAgICAgICAgICAgIHJ1bGU6ICd0eXBlJyxcbiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZTogYFByb3BlcnR5ICR7a2V5fSBtdXN0IGJlIGEgZGF0ZSBhZnRlciAke2RlZmluaXRpb24uYWZ0ZXJ9YFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBudWxsXG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgc3RhdGljIGdldFZhbGlkYXRvcnNGb3JLZXkoa2V5OiBzdHJpbmcsIGRlZmluaXRpb246IFZhbGlkYXRpb25EZWZpbml0aW9uLCBvcHRpb25zOiBWYWxpZGF0aW9uT3B0aW9ucywgb2JqZWN0PzogYW55KSB7XG4gICAgICAgIGNvbnN0IHZhbGlkYXRvcnM6IGFueSA9IHtcbiAgICAgICAgICAgIHR5cGU6IGNsZWFuZWQoRGF0ZVZhbGlkYXRvci5SVUxFUy50eXBlLCBrZXksIGRlZmluaXRpb24sIG9wdGlvbnMpXG4gICAgICAgIH1cblxuICAgICAgICBpZiAoZGVmaW5pdGlvbi5iZWZvcmUpIHtcbiAgICAgICAgICAgIF8uYXNzaWduKHZhbGlkYXRvcnMsIGNsZWFuZWQoRGF0ZVZhbGlkYXRvci5SVUxFUy5iZWZvcmUsIGtleSwgZGVmaW5pdGlvbiwgb3B0aW9ucykpXG4gICAgICAgIH1cblxuICAgICAgICBpZiAoZGVmaW5pdGlvbi5hZnRlcikge1xuICAgICAgICAgICAgXy5hc3NpZ24odmFsaWRhdG9ycywgY2xlYW5lZChEYXRlVmFsaWRhdG9yLlJVTEVTLmFmdGVyLCBrZXksIGRlZmluaXRpb24sIG9wdGlvbnMpKVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHZhbGlkYXRvcnNcbiAgICB9XG5cbiAgICB2YWxpZGF0ZShrZXk6IHN0cmluZywgZGVmaW5pdGlvbjogVmFsaWRhdGlvbkRlZmluaXRpb24sIHZhbHVlOiBhbnksIG9wdGlvbnM6IFZhbGlkYXRpb25PcHRpb25zKTogVmFsaWRhdGlvblJlc3VsdCB7XG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IG5ldyBDb21wb3NlZFZhbGlkYXRpb25SZXN1bHQoKVxuICAgICAgICBjb25zdCBydWxlcyA9IERhdGVWYWxpZGF0b3IuUlVMRVNcblxuICAgICAgICByZXN1bHQuYW5kKHJ1bGVzLnR5cGUodmFsdWUsIGtleSwgZGVmaW5pdGlvbikpXG4gICAgICAgIGlmIChyZXN1bHQuaXNWYWxpZCgpKSB7XG4gICAgICAgICAgICByZXN1bHQuYW5kKHJ1bGVzLmJlZm9yZSh2YWx1ZSwga2V5LCBkZWZpbml0aW9uKSlcbiAgICAgICAgICAgIHJlc3VsdC5hbmQocnVsZXMuYWZ0ZXIodmFsdWUsIGtleSwgZGVmaW5pdGlvbikpXG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gcmVzdWx0XG4gICAgfVxuXG4gICAgY2xlYW4oZGVmaW5pdGlvbjogVmFsaWRhdGlvbkRlZmluaXRpb24sIHZhbHVlOiBhbnksIG9wdGlvbnM6IENsZWFuT3B0aW9ucywgb2JqZWN0OiBhbnkpOiBhbnkge1xuICAgICAgICBpZiAoIW9wdGlvbnMuYXV0b0NvbnZlcnQpIHtcbiAgICAgICAgICAgIHJldHVybiB2YWx1ZVxuICAgICAgICB9XG4gICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICBpZiAodHlwZW9mIGRlZmluaXRpb24uZGF0ZUZvcm1hdCA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gbW9tZW50KHZhbHVlLCBkZWZpbml0aW9uLmRhdGVGb3JtYXQpLnRvRGF0ZSgpXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJldHVybiBtb21lbnQodmFsdWUpLnRvRGF0ZSgpXG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHZhbHVlXG4gICAgfVxufVxuIl19
