"use strict";
var _ = require('lodash');
var composed_validation_result_1 = require('../composed-validation-result');
var string_validator_1 = require('./string-validator');
var number_validator_1 = require('./number-validator');
var date_validator_1 = require('./date-validator');
var object_validator_1 = require('./object-validator');
var schema_validator_1 = require('./schema-validator');
var boolean_validator_1 = require('./boolean-validator');
var schema_1 = require('../schema');
var cleaned_1 = require('../cleaned');
var RootValidator = (function () {
    function RootValidator() {
    }
    // for the type rule, the value is valid if at least one type is valid
    RootValidator.createTypeValidator = function (key, types, validatorsByType) {
        return function (value, object, options) {
            for (var _i = 0, types_1 = types; _i < types_1.length; _i++) {
                var type = types_1[_i];
                var validator = validatorsByType[type.name].type;
                if (validator(value, object, options) === null) {
                    return null;
                }
            }
            return {
                property: key,
                rule: 'type',
                message: "Property " + key + " must be one of [" + Object.keys(validatorsByType).join(', ') + "]"
            };
        };
    };
    // every other rule gets passed down to every typeValidator that supports the rule
    RootValidator.createRuleValidator = function (rule, types, validatorsByType) {
        return function (value, object, options) {
            for (var _i = 0, types_2 = types; _i < types_2.length; _i++) {
                var type = types_2[_i];
                var validator = validatorsByType[type.name][rule];
                if (typeof validator === 'function') {
                    return validator(value, object, options);
                }
            }
            return null;
        };
    };
    RootValidator.createArrayValidator = function (validator, key) {
        return function (value, object, options) {
            if (_.isArray(value)) {
                var result = new composed_validation_result_1.ComposedValidationResult();
                for (var index = 0; index < value.length; index++) {
                    result.and(validator(value[index], object, options), null, index);
                }
                return result;
            }
            return null;
        };
    };
    RootValidator.getValidatorsForKey = function (key, definition, options, object) {
        var validators = {};
        if (!definition.optional) {
            validators.required = cleaned_1.cleaned(RootValidator.RULES.required, key, definition, options);
        }
        if (definition.allowedValues) {
            validators.allowedValues = cleaned_1.cleaned(RootValidator.RULES.allowedValues, key, definition, options);
        }
        if (definition.array) {
            validators.isArray = cleaned_1.cleaned(RootValidator.RULES.isArray, key, definition, options);
        }
        if (typeof definition.minCount !== 'undefined') {
            validators.minCount = cleaned_1.cleaned(RootValidator.RULES.minCount, key, definition, options);
        }
        if (typeof definition.maxCount !== 'undefined') {
            validators.maxCount = cleaned_1.cleaned(RootValidator.RULES.maxCount, key, definition, options);
        }
        if (definition.custom) {
            if (typeof definition.custom === 'function') {
                validators.custom = cleaned_1.cleaned(RootValidator.RULES.custom, key, definition, options, object, definition.custom, 'custom');
            }
            else if (typeof definition.custom === 'object') {
                for (var rule in definition.custom) {
                    if (definition.custom.hasOwnProperty(rule)) {
                        validators[rule] = cleaned_1.cleaned(RootValidator.RULES.custom, key, definition, options, object, definition.custom[rule], rule);
                    }
                }
            }
        }
        var types = _.isArray(definition.type) ? definition.type : [definition.type];
        var validatorsByType = {};
        var rules = [];
        for (var _i = 0, types_3 = types; _i < types_3.length; _i++) {
            var type = types_3[_i];
            var validators_1 = this.getValidator(type).getValidatorsForKey(key, definition, options, object);
            validatorsByType[type.name] = validators_1;
            rules = _.union(rules, Object.keys(validators_1));
        }
        if (definition.array) {
            for (var _a = 0, rules_1 = rules; _a < rules_1.length; _a++) {
                var rule = rules_1[_a];
                validators[rule] = rule === 'type' ?
                    RootValidator.createArrayValidator(RootValidator.createTypeValidator(key, types, validatorsByType), key) :
                    RootValidator.createArrayValidator(RootValidator.createRuleValidator(rule, types, validatorsByType), key);
            }
        }
        else {
            for (var _b = 0, rules_2 = rules; _b < rules_2.length; _b++) {
                var rule = rules_2[_b];
                validators[rule] = rule === 'type' ?
                    RootValidator.createTypeValidator(key, types, validatorsByType) :
                    RootValidator.createRuleValidator(rule, types, validatorsByType);
            }
        }
        return validators;
    };
    RootValidator.getValidator = function (type) {
        switch (type) {
            case String:
                return string_validator_1.StringValidator;
            case Number:
                return number_validator_1.NumberValidator;
            case Date:
                return date_validator_1.DateValidator;
            case Object:
                return object_validator_1.ObjectValidator;
            case Boolean:
                return boolean_validator_1.BooleanValidator;
            default:
                if (type instanceof schema_1.Schema) {
                    return schema_validator_1.SchemaValidator;
                }
                else {
                    throw new Error("Unkown type " + type + " used in schema");
                }
        }
    };
    RootValidator.clean = function (definition, value, options, object) {
        var result = value;
        if (options.removeEmptyStrings && typeof result === 'string' && value.trim().length === 0) {
            if (definition.removeEmpty !== false) {
                result = null;
            }
        }
        else if (options.removeEmptyObjects && typeof result === 'object' && _.isEmpty(result) && !_.isDate(result)) {
            if (definition.removeEmpty !== false) {
                result = null;
            }
        }
        var types = Array.isArray(definition.type) ? definition.type : [definition.type];
        if (typeof result === 'undefined' || result == null) {
            if (typeof definition.defaultValue !== 'undefined') {
                result = _.cloneDeep(definition.defaultValue);
            }
        }
        if (options.getAutoValues && typeof definition.autoValue === 'function') {
            result = definition.autoValue(result, object);
        }
        for (var _i = 0, _a = _.reverse(types); _i < _a.length; _i++) {
            var type = _a[_i];
            result = RootValidator.getValidator(type).clean(definition, result, options, object);
        }
        return result;
    };
    RootValidator.RULES = {
        isArray: function (value, key, definition) {
            if ((typeof value !== 'undefined' && value !== null) && !Array.isArray(value)) {
                return {
                    property: key,
                    rule: 'type',
                    message: "Property " + key + " expected to be an array of type " + definition.type.name
                };
            }
            return null;
        },
        minCount: function (value, key, definition) {
            if ((typeof value !== 'undefined' && value !== null) && (typeof definition.minCount === 'number') && value.length < definition.minCount) {
                return {
                    property: key,
                    rule: 'minCount',
                    message: "Property " + key + " expected to be an array of type " + definition.type.name + " with at least " + definition.minCount + " elements"
                };
            }
            return null;
        },
        maxCount: function (value, key, definition) {
            if ((typeof value !== 'undefined' && value !== null) && (typeof definition.maxCount === 'number') && value.length > definition.maxCount) {
                return {
                    property: key,
                    rule: 'maxCount',
                    message: "Property " + key + " expected to be an array of type " + definition.type.name + " with at max " + definition.maxCount + " elements"
                };
            }
            return null;
        },
        required: function (value, key, definition) {
            if (!definition.optional && (typeof value === 'undefined' || value == null)) {
                return {
                    property: key,
                    rule: 'required',
                    message: "Missing value for property " + key
                };
            }
            return null;
        },
        allowedValues: function (value, key, definition) {
            if ((typeof value !== 'undefined' && value !== null) && typeof definition.allowedValues !== 'undefined') {
                if (!(value in definition.allowedValues)) {
                    return {
                        property: key,
                        rule: 'allowedValues',
                        message: "Value of " + key + " is not in allowedValues"
                    };
                }
            }
            return null;
        },
        custom: function (value, key, defintion, object, options, custom, rule) {
            var error = custom(value, object, options.context);
            if (typeof error === 'string') {
                return {
                    property: key,
                    rule: rule,
                    message: error
                };
            }
            return null;
        }
    };
    return RootValidator;
}());
exports.RootValidator = RootValidator;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInZhbGlkYXRvcnMvcm9vdC12YWxpZGF0b3IudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLElBQVksQ0FBQyxXQUFNLFFBRW5CLENBQUMsQ0FGMEI7QUFVM0IsMkNBQXlDLCtCQUN6QyxDQUFDLENBRHVFO0FBQ3hFLGlDQUFnQyxvQkFDaEMsQ0FBQyxDQURtRDtBQUNwRCxpQ0FBZ0Msb0JBQ2hDLENBQUMsQ0FEbUQ7QUFDcEQsK0JBQThCLGtCQUM5QixDQUFDLENBRCtDO0FBQ2hELGlDQUFnQyxvQkFDaEMsQ0FBQyxDQURtRDtBQUNwRCxpQ0FBZ0Msb0JBQ2hDLENBQUMsQ0FEbUQ7QUFDcEQsa0NBQWlDLHFCQUNqQyxDQUFDLENBRHFEO0FBQ3RELHVCQUF1QixXQUN2QixDQUFDLENBRGlDO0FBQ2xDLHdCQUF3QixZQUV4QixDQUFDLENBRm1DO0FBRXBDO0lBQUE7SUF3T0EsQ0FBQztJQWxLRyxzRUFBc0U7SUFDdkQsaUNBQW1CLEdBQWxDLFVBQW1DLEdBQVcsRUFBRSxLQUFpQixFQUFFLGdCQUFxQjtRQUNwRixNQUFNLENBQUMsVUFBQyxLQUFVLEVBQUUsTUFBWSxFQUFFLE9BQTJCO1lBQ3pELEdBQUcsQ0FBQyxDQUFhLFVBQUssRUFBTCxlQUFLLEVBQUwsbUJBQUssRUFBTCxJQUFLLENBQUM7Z0JBQWxCLElBQUksSUFBSSxjQUFBO2dCQUNULElBQU0sU0FBUyxHQUFHLGdCQUFnQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUE7Z0JBQ2xELEVBQUUsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxLQUFLLEVBQUUsTUFBTSxFQUFFLE9BQU8sQ0FBQyxLQUFLLElBQUksQ0FBQyxDQUFDLENBQUM7b0JBQzdDLE1BQU0sQ0FBQyxJQUFJLENBQUE7Z0JBQ2YsQ0FBQzthQUNKO1lBQ0QsTUFBTSxDQUFDO2dCQUNILFFBQVEsRUFBRSxHQUFHO2dCQUNiLElBQUksRUFBRSxNQUFNO2dCQUNaLE9BQU8sRUFBRSxjQUFZLEdBQUcseUJBQW9C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QUF4T1kscUJBQWEsZ0JBd096QixDQUFBIiwiZmlsZSI6InZhbGlkYXRvcnMvcm9vdC12YWxpZGF0b3IuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBfIGZyb20gJ2xvZGFzaCdcblxuaW1wb3J0IHtcbiAgICBWYWxpZGF0aW9uRGVmaW5pdGlvbixcbiAgICBEZWZpbml0aW9uVHlwZSxcbiAgICBWYWxpZGF0aW9uUmVzdWx0LFxuICAgIFZhbGlkYXRpb25PcHRpb25zLFxuICAgIFZhbGlkYXRpb25FcnJvcixcbiAgICBDbGVhbk9wdGlvbnNcbn0gZnJvbSAnLi4vaW50ZXJmYWNlcydcbmltcG9ydCB7IENvbXBvc2VkVmFsaWRhdGlvblJlc3VsdCB9IGZyb20gJy4uL2NvbXBvc2VkLXZhbGlkYXRpb24tcmVzdWx0J1xuaW1wb3J0IHsgU3RyaW5nVmFsaWRhdG9yIH0gZnJvbSAnLi9zdHJpbmctdmFsaWRhdG9yJ1xuaW1wb3J0IHsgTnVtYmVyVmFsaWRhdG9yIH0gZnJvbSAnLi9udW1iZXItdmFsaWRhdG9yJ1xuaW1wb3J0IHsgRGF0ZVZhbGlkYXRvciB9IGZyb20gJy4vZGF0ZS12YWxpZGF0b3InXG5pbXBvcnQgeyBPYmplY3RWYWxpZGF0b3IgfSBmcm9tICcuL29iamVjdC12YWxpZGF0b3InXG5pbXBvcnQgeyBTY2hlbWFWYWxpZGF0b3IgfSBmcm9tICcuL3NjaGVtYS12YWxpZGF0b3InXG5pbXBvcnQgeyBCb29sZWFuVmFsaWRhdG9yIH0gZnJvbSAnLi9ib29sZWFuLXZhbGlkYXRvcidcbmltcG9ydCB7IFNjaGVtYSB9IGZyb20gJy4uL3NjaGVtYSdcbmltcG9ydCB7IGNsZWFuZWQgfSBmcm9tICcuLi9jbGVhbmVkJ1xuXG5leHBvcnQgY2xhc3MgUm9vdFZhbGlkYXRvciB7XG5cbiAgICBwdWJsaWMgc3RhdGljIFJVTEVTID0ge1xuICAgICAgICBpc0FycmF5OiAodmFsdWU6IGFueSwga2V5OiBzdHJpbmcsIGRlZmluaXRpb246IFZhbGlkYXRpb25EZWZpbml0aW9uKTogVmFsaWRhdGlvbkVycm9yIHwgbnVsbCA9PiB7XG4gICAgICAgICAgICBpZiAoKHR5cGVvZiB2YWx1ZSAhPT0gJ3VuZGVmaW5lZCcgJiYgdmFsdWUgIT09IG51bGwpICYmICFBcnJheS5pc0FycmF5KHZhbHVlKSkge1xuICAgICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgICAgIHByb3BlcnR5OiBrZXksXG4gICAgICAgICAgICAgICAgICAgIHJ1bGU6ICd0eXBlJyxcbiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZTogYFByb3BlcnR5ICR7a2V5fSBleHBlY3RlZCB0byBiZSBhbiBhcnJheSBvZiB0eXBlICR7ZGVmaW5pdGlvbi50eXBlLm5hbWV9YFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBudWxsXG4gICAgICAgIH0sXG4gICAgICAgIG1pbkNvdW50OiAodmFsdWU6IGFueSwga2V5OiBzdHJpbmcsIGRlZmluaXRpb246IFZhbGlkYXRpb25EZWZpbml0aW9uKTogVmFsaWRhdGlvbkVycm9yIHwgbnVsbCA9PiB7XG4gICAgICAgICAgICBpZiAoKHR5cGVvZiB2YWx1ZSAhPT0gJ3VuZGVmaW5lZCcgJiYgdmFsdWUgIT09IG51bGwpICYmICh0eXBlb2YgZGVmaW5pdGlvbi5taW5Db3VudCA9PT0gJ251bWJlcicpICYmIHZhbHVlLmxlbmd0aCA8IGRlZmluaXRpb24ubWluQ291bnQpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgICAgICBwcm9wZXJ0eToga2V5LFxuICAgICAgICAgICAgICAgICAgICBydWxlOiAnbWluQ291bnQnLFxuICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiBgUHJvcGVydHkgJHtrZXl9IGV4cGVjdGVkIHRvIGJlIGFuIGFycmF5IG9mIHR5cGUgJHtkZWZpbml0aW9uLnR5cGUubmFtZX0gd2l0aCBhdCBsZWFzdCAke2RlZmluaXRpb24ubWluQ291bnR9IGVsZW1lbnRzYFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIG51bGxcbiAgICAgICAgfSxcbiAgICAgICAgbWF4Q291bnQ6ICh2YWx1ZTogYW55LCBrZXk6IHN0cmluZywgZGVmaW5pdGlvbjogVmFsaWRhdGlvbkRlZmluaXRpb24pOiBWYWxpZGF0aW9uRXJyb3IgfCBudWxsID0+IHtcbiAgICAgICAgICAgIGlmICgodHlwZW9mIHZhbHVlICE9PSAndW5kZWZpbmVkJyAmJiB2YWx1ZSAhPT0gbnVsbCkgJiYgKHR5cGVvZiBkZWZpbml0aW9uLm1heENvdW50ID09PSAnbnVtYmVyJykgJiYgdmFsdWUubGVuZ3RoID4gZGVmaW5pdGlvbi5tYXhDb3VudCkge1xuICAgICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgICAgIHByb3BlcnR5OiBrZXksXG4gICAgICAgICAgICAgICAgICAgIHJ1bGU6ICdtYXhDb3VudCcsXG4gICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IGBQcm9wZXJ0eSAke2tleX0gZXhwZWN0ZWQgdG8gYmUgYW4gYXJyYXkgb2YgdHlwZSAke2RlZmluaXRpb24udHlwZS5uYW1lfSB3aXRoIGF0IG1heCAke2RlZmluaXRpb24ubWF4Q291bnR9IGVsZW1lbnRzYFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBudWxsXG4gICAgICAgIH0sXG4gICAgICAgIHJlcXVpcmVkOiAodmFsdWU6IGFueSwga2V5OiBzdHJpbmcsIGRlZmluaXRpb246IFZhbGlkYXRpb25EZWZpbml0aW9uKTogVmFsaWRhdGlvbkVycm9yIHwgbnVsbCA9PiB7XG4gICAgICAgICAgICBpZiAoIWRlZmluaXRpb24ub3B0aW9uYWwgJiYgKHR5cGVvZiB2YWx1ZSA9PT0gJ3VuZGVmaW5lZCcgfHwgdmFsdWUgPT0gbnVsbCkpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgICAgICBwcm9wZXJ0eToga2V5LFxuICAgICAgICAgICAgICAgICAgICBydWxlOiAncmVxdWlyZWQnLFxuICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiBgTWlzc2luZyB2YWx1ZSBmb3IgcHJvcGVydHkgJHtrZXl9YFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBudWxsXG4gICAgICAgIH0sXG4gICAgICAgIGFsbG93ZWRWYWx1ZXM6ICh2YWx1ZTogYW55LCBrZXk6IHN0cmluZywgZGVmaW5pdGlvbjogVmFsaWRhdGlvbkRlZmluaXRpb24pOiBWYWxpZGF0aW9uRXJyb3IgfCBudWxsID0+IHtcbiAgICAgICAgICAgIGlmICgodHlwZW9mIHZhbHVlICE9PSAndW5kZWZpbmVkJyAmJiB2YWx1ZSAhPT0gbnVsbCkgJiYgdHlwZW9mIGRlZmluaXRpb24uYWxsb3dlZFZhbHVlcyAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICAgICAgICBpZiAoISh2YWx1ZSBpbiBkZWZpbml0aW9uLmFsbG93ZWRWYWx1ZXMpKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBwcm9wZXJ0eToga2V5LFxuICAgICAgICAgICAgICAgICAgICAgICAgcnVsZTogJ2FsbG93ZWRWYWx1ZXMnLFxuICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZTogYFZhbHVlIG9mICR7a2V5fSBpcyBub3QgaW4gYWxsb3dlZFZhbHVlc2BcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBudWxsXG4gICAgICAgIH0sXG4gICAgICAgIGN1c3RvbTogKHZhbHVlOiBhbnksIGtleTogc3RyaW5nLCBkZWZpbnRpb246IFZhbGlkYXRpb25EZWZpbml0aW9uLCBvYmplY3Q6IGFueSwgb3B0aW9uczogVmFsaWRhdGlvbk9wdGlvbnMsIGN1c3RvbTogRnVuY3Rpb24sIHJ1bGU6IHN0cmluZyk6IFZhbGlkYXRpb25FcnJvciB8IG51bGwgPT4ge1xuICAgICAgICAgICAgY29uc3QgZXJyb3IgPSBjdXN0b20odmFsdWUsIG9iamVjdCwgb3B0aW9ucy5jb250ZXh0KVxuXG4gICAgICAgICAgICBpZiAodHlwZW9mIGVycm9yID09PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgICAgIHByb3BlcnR5OiBrZXksXG4gICAgICAgICAgICAgICAgICAgIHJ1bGU6IHJ1bGUsXG4gICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IGVycm9yXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIG51bGxcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8vIGZvciB0aGUgdHlwZSBydWxlLCB0aGUgdmFsdWUgaXMgdmFsaWQgaWYgYXQgbGVhc3Qgb25lIHR5cGUgaXMgdmFsaWRcbiAgICBwcml2YXRlIHN0YXRpYyBjcmVhdGVUeXBlVmFsaWRhdG9yKGtleTogc3RyaW5nLCB0eXBlczogRnVuY3Rpb25bXSwgdmFsaWRhdG9yc0J5VHlwZTogYW55KSB7XG4gICAgICAgIHJldHVybiAodmFsdWU6IGFueSwgb2JqZWN0PzogYW55LCBvcHRpb25zPzogVmFsaWRhdGlvbk9wdGlvbnMpID0+IHtcbiAgICAgICAgICAgIGZvciAobGV0IHR5cGUgb2YgdHlwZXMpIHtcbiAgICAgICAgICAgICAgICBjb25zdCB2YWxpZGF0b3IgPSB2YWxpZGF0b3JzQnlUeXBlW3R5cGUubmFtZV0udHlwZVxuICAgICAgICAgICAgICAgIGlmICh2YWxpZGF0b3IodmFsdWUsIG9iamVjdCwgb3B0aW9ucykgPT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGxcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgIHByb3BlcnR5OiBrZXksXG4gICAgICAgICAgICAgICAgcnVsZTogJ3R5cGUnLFxuICAgICAgICAgICAgICAgIG1lc3NhZ2U6IGBQcm9wZXJ0eSAke2tleX0gbXVzdCBiZSBvbmUgb2YgWyR7T2JqZWN0LmtleXModmFsaWRhdG9yc0J5VHlwZSkuam9pbignLCAnKX1dYFxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgLy8gZXZlcnkgb3RoZXIgcnVsZSBnZXRzIHBhc3NlZCBkb3duIHRvIGV2ZXJ5IHR5cGVWYWxpZGF0b3IgdGhhdCBzdXBwb3J0cyB0aGUgcnVsZVxuICAgIHByaXZhdGUgc3RhdGljIGNyZWF0ZVJ1bGVWYWxpZGF0b3IocnVsZTogc3RyaW5nLCB0eXBlczogRnVuY3Rpb25bXSwgdmFsaWRhdG9yc0J5VHlwZTogYW55KSB7XG4gICAgICAgIHJldHVybiAodmFsdWU6IGFueSwgb2JqZWN0PzogYW55LCBvcHRpb25zPzogVmFsaWRhdGlvbk9wdGlvbnMpID0+IHtcbiAgICAgICAgICAgIGZvciAobGV0IHR5cGUgb2YgdHlwZXMpIHtcbiAgICAgICAgICAgICAgICBjb25zdCB2YWxpZGF0b3IgPSB2YWxpZGF0b3JzQnlUeXBlW3R5cGUubmFtZV1bcnVsZV1cblxuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdmFsaWRhdG9yID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB2YWxpZGF0b3IodmFsdWUsIG9iamVjdCwgb3B0aW9ucylcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gbnVsbFxuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzdGF0aWMgY3JlYXRlQXJyYXlWYWxpZGF0b3IodmFsaWRhdG9yOiAodmFsdWU6IGFueSwgb2JqZWN0PzogYW55LCBvcHRpb25zPzogVmFsaWRhdGlvbk9wdGlvbnMpID0+IGFueSwga2V5OiBzdHJpbmcpIHtcbiAgICAgICAgcmV0dXJuICh2YWx1ZTogYW55LCBvYmplY3Q/OiBhbnksIG9wdGlvbnM/OiBWYWxpZGF0aW9uT3B0aW9ucykgPT4ge1xuICAgICAgICAgICAgaWYgKF8uaXNBcnJheSh2YWx1ZSkpIHtcbiAgICAgICAgICAgICAgICBjb25zdCByZXN1bHQgPSBuZXcgQ29tcG9zZWRWYWxpZGF0aW9uUmVzdWx0KClcbiAgICAgICAgICAgICAgICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgdmFsdWUubGVuZ3RoOyBpbmRleCsrKSB7XG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdC5hbmQodmFsaWRhdG9yKHZhbHVlW2luZGV4XSwgb2JqZWN0LCBvcHRpb25zKSwgbnVsbCwgaW5kZXgpXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHRcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBudWxsXG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgc3RhdGljIGdldFZhbGlkYXRvcnNGb3JLZXkoa2V5OiBzdHJpbmcsIGRlZmluaXRpb246IFZhbGlkYXRpb25EZWZpbml0aW9uLCBvcHRpb25zOiBWYWxpZGF0aW9uT3B0aW9ucywgb2JqZWN0PzogYW55KSB7XG4gICAgICAgIGNvbnN0IHZhbGlkYXRvcnM6IGFueSA9IHt9XG5cbiAgICAgICAgaWYgKCFkZWZpbml0aW9uLm9wdGlvbmFsKSB7XG4gICAgICAgICAgICB2YWxpZGF0b3JzLnJlcXVpcmVkID0gY2xlYW5lZChSb290VmFsaWRhdG9yLlJVTEVTLnJlcXVpcmVkLCBrZXksIGRlZmluaXRpb24sIG9wdGlvbnMpXG4gICAgICAgIH1cblxuICAgICAgICBpZiAoZGVmaW5pdGlvbi5hbGxvd2VkVmFsdWVzKSB7XG4gICAgICAgICAgICB2YWxpZGF0b3JzLmFsbG93ZWRWYWx1ZXMgPSBjbGVhbmVkKFJvb3RWYWxpZGF0b3IuUlVMRVMuYWxsb3dlZFZhbHVlcywga2V5LCBkZWZpbml0aW9uLCBvcHRpb25zKVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGRlZmluaXRpb24uYXJyYXkpIHtcbiAgICAgICAgICAgIHZhbGlkYXRvcnMuaXNBcnJheSA9IGNsZWFuZWQoUm9vdFZhbGlkYXRvci5SVUxFUy5pc0FycmF5LCBrZXksIGRlZmluaXRpb24sIG9wdGlvbnMpXG4gICAgICAgIH1cblxuICAgICAgICBpZiAodHlwZW9mIGRlZmluaXRpb24ubWluQ291bnQgIT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgICB2YWxpZGF0b3JzLm1pbkNvdW50ID0gY2xlYW5lZChSb290VmFsaWRhdG9yLlJVTEVTLm1pbkNvdW50LCBrZXksIGRlZmluaXRpb24sIG9wdGlvbnMpXG4gICAgICAgIH1cblxuICAgICAgICBpZiAodHlwZW9mIGRlZmluaXRpb24ubWF4Q291bnQgIT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgICB2YWxpZGF0b3JzLm1heENvdW50ID0gY2xlYW5lZChSb290VmFsaWRhdG9yLlJVTEVTLm1heENvdW50LCBrZXksIGRlZmluaXRpb24sIG9wdGlvbnMpXG4gICAgICAgIH1cblxuICAgICAgICBpZiAoZGVmaW5pdGlvbi5jdXN0b20pICB7XG4gICAgICAgICAgICBpZiAodHlwZW9mIGRlZmluaXRpb24uY3VzdG9tID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICAgICAgdmFsaWRhdG9ycy5jdXN0b20gPSBjbGVhbmVkKFJvb3RWYWxpZGF0b3IuUlVMRVMuY3VzdG9tLCBrZXksIGRlZmluaXRpb24sIG9wdGlvbnMsIG9iamVjdCwgZGVmaW5pdGlvbi5jdXN0b20sICdjdXN0b20nKVxuICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgZGVmaW5pdGlvbi5jdXN0b20gPT09ICdvYmplY3QnKSB7XG4gICAgICAgICAgICAgICAgZm9yIChsZXQgcnVsZSBpbiBkZWZpbml0aW9uLmN1c3RvbSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoZGVmaW5pdGlvbi5jdXN0b20uaGFzT3duUHJvcGVydHkocnVsZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhbGlkYXRvcnNbcnVsZV0gPSBjbGVhbmVkKFJvb3RWYWxpZGF0b3IuUlVMRVMuY3VzdG9tLCBrZXksIGRlZmluaXRpb24sIG9wdGlvbnMsIG9iamVjdCwgZGVmaW5pdGlvbi5jdXN0b21bcnVsZV0sIHJ1bGUpXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuXG4gICAgICAgIGNvbnN0IHR5cGVzID0gXy5pc0FycmF5PERlZmluaXRpb25UeXBlPihkZWZpbml0aW9uLnR5cGUpID8gZGVmaW5pdGlvbi50eXBlIDogW2RlZmluaXRpb24udHlwZV1cblxuICAgICAgICBjb25zdCB2YWxpZGF0b3JzQnlUeXBlOiBhbnkgPSB7fVxuICAgICAgICBsZXQgcnVsZXM6IGFueVtdID0gW11cblxuICAgICAgICBmb3IgKGxldCB0eXBlIG9mIHR5cGVzKSB7XG4gICAgICAgICAgICBjb25zdCB2YWxpZGF0b3JzID0gdGhpcy5nZXRWYWxpZGF0b3IodHlwZSkuZ2V0VmFsaWRhdG9yc0ZvcktleShrZXksIGRlZmluaXRpb24sIG9wdGlvbnMsIG9iamVjdClcbiAgICAgICAgICAgIHZhbGlkYXRvcnNCeVR5cGVbdHlwZS5uYW1lXSA9IHZhbGlkYXRvcnNcbiAgICAgICAgICAgIHJ1bGVzID0gXy51bmlvbihydWxlcywgT2JqZWN0LmtleXModmFsaWRhdG9ycykpXG4gICAgICAgIH1cblxuICAgICAgICBpZiAoZGVmaW5pdGlvbi5hcnJheSkge1xuICAgICAgICAgICAgZm9yIChsZXQgcnVsZSBvZiBydWxlcykge1xuICAgICAgICAgICAgICAgIHZhbGlkYXRvcnNbcnVsZV0gPSBydWxlID09PSAndHlwZScgP1xuICAgICAgICAgICAgICAgICAgICBSb290VmFsaWRhdG9yLmNyZWF0ZUFycmF5VmFsaWRhdG9yKFJvb3RWYWxpZGF0b3IuY3JlYXRlVHlwZVZhbGlkYXRvcihrZXksIHR5cGVzLCB2YWxpZGF0b3JzQnlUeXBlKSwga2V5KSA6XG4gICAgICAgICAgICAgICAgICAgIFJvb3RWYWxpZGF0b3IuY3JlYXRlQXJyYXlWYWxpZGF0b3IoUm9vdFZhbGlkYXRvci5jcmVhdGVSdWxlVmFsaWRhdG9yKHJ1bGUsIHR5cGVzLCB2YWxpZGF0b3JzQnlUeXBlKSwga2V5KVxuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgZm9yIChsZXQgcnVsZSBvZiBydWxlcykge1xuICAgICAgICAgICAgICAgIHZhbGlkYXRvcnNbcnVsZV0gPSBydWxlID09PSAndHlwZScgP1xuICAgICAgICAgICAgICAgICAgICBSb290VmFsaWRhdG9yLmNyZWF0ZVR5cGVWYWxpZGF0b3Ioa2V5LCB0eXBlcywgdmFsaWRhdG9yc0J5VHlwZSkgOlxuICAgICAgICAgICAgICAgICAgICBSb290VmFsaWRhdG9yLmNyZWF0ZVJ1bGVWYWxpZGF0b3IocnVsZSwgdHlwZXMsIHZhbGlkYXRvcnNCeVR5cGUpXG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdmFsaWRhdG9yc1xuICAgIH1cblxuICAgIHB1YmxpYyBzdGF0aWMgZ2V0VmFsaWRhdG9yKHR5cGU6IERlZmluaXRpb25UeXBlKToge1xuICAgICAgICAgICAgZ2V0VmFsaWRhdG9yc0ZvcktleTogKGtleTogc3RyaW5nLCBkZWZpbml0aW9uOiBWYWxpZGF0aW9uRGVmaW5pdGlvbiwgb3B0aW9uczogVmFsaWRhdGlvbk9wdGlvbnMsIG9iamVjdDogYW55KSA9PiBhbnksXG4gICAgICAgICAgICBjbGVhbjogKGRlZmluaXRpb246IFZhbGlkYXRpb25EZWZpbml0aW9uLCB2YWx1ZTogYW55LCBvcHRpb25zOiBDbGVhbk9wdGlvbnMsIG9iamVjdDogYW55KSA9PiBhbnlcbiAgICB9IHtcbiAgICAgICAgc3dpdGNoICh0eXBlKSB7XG4gICAgICAgICAgICBjYXNlIFN0cmluZzpcbiAgICAgICAgICAgICAgICByZXR1cm4gU3RyaW5nVmFsaWRhdG9yXG4gICAgICAgICAgICBjYXNlIE51bWJlcjpcbiAgICAgICAgICAgICAgICByZXR1cm4gTnVtYmVyVmFsaWRhdG9yXG4gICAgICAgICAgICBjYXNlIERhdGU6XG4gICAgICAgICAgICAgICAgcmV0dXJuIERhdGVWYWxpZGF0b3JcbiAgICAgICAgICAgIGNhc2UgT2JqZWN0OlxuICAgICAgICAgICAgICAgIHJldHVybiBPYmplY3RWYWxpZGF0b3JcbiAgICAgICAgICAgIGNhc2UgQm9vbGVhbjpcbiAgICAgICAgICAgICAgICByZXR1cm4gQm9vbGVhblZhbGlkYXRvclxuICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgICAgICBpZiAodHlwZSBpbnN0YW5jZW9mIFNjaGVtYSkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gU2NoZW1hVmFsaWRhdG9yXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmtvd24gdHlwZSAke3R5cGV9IHVzZWQgaW4gc2NoZW1hYClcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgc3RhdGljIGNsZWFuKGRlZmluaXRpb246IFZhbGlkYXRpb25EZWZpbml0aW9uLCB2YWx1ZTogYW55LCBvcHRpb25zOiBDbGVhbk9wdGlvbnMsIG9iamVjdDogYW55KTogYW55IHtcbiAgICAgICAgbGV0IHJlc3VsdDogYW55ID0gdmFsdWVcblxuICAgICAgICBpZiAob3B0aW9ucy5yZW1vdmVFbXB0eVN0cmluZ3MgJiYgdHlwZW9mIHJlc3VsdCA9PT0gJ3N0cmluZycgJiYgdmFsdWUudHJpbSgpLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgaWYgKGRlZmluaXRpb24ucmVtb3ZlRW1wdHkgIT09IGZhbHNlKSB7XG4gICAgICAgICAgICAgICAgcmVzdWx0ID0gbnVsbFxuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2UgaWYgKG9wdGlvbnMucmVtb3ZlRW1wdHlPYmplY3RzICYmIHR5cGVvZiByZXN1bHQgPT09ICdvYmplY3QnICYmIF8uaXNFbXB0eShyZXN1bHQpICYmICFfLmlzRGF0ZShyZXN1bHQpKSB7XG4gICAgICAgICAgICBpZiAoZGVmaW5pdGlvbi5yZW1vdmVFbXB0eSAhPT0gZmFsc2UpIHtcbiAgICAgICAgICAgICAgICByZXN1bHQgPSBudWxsXG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgdHlwZXM6IERlZmluaXRpb25UeXBlW10gPSBBcnJheS5pc0FycmF5KGRlZmluaXRpb24udHlwZSkgPyAoZGVmaW5pdGlvbi50eXBlIGFzIERlZmluaXRpb25UeXBlW10pIDogW2RlZmluaXRpb24udHlwZSBhcyBEZWZpbml0aW9uVHlwZV1cblxuICAgICAgICBpZiAodHlwZW9mIHJlc3VsdCA9PT0gJ3VuZGVmaW5lZCcgfHwgcmVzdWx0ID09IG51bGwpIHtcbiAgICAgICAgICAgIGlmICh0eXBlb2YgZGVmaW5pdGlvbi5kZWZhdWx0VmFsdWUgIT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgICAgICAgcmVzdWx0ID0gXy5jbG9uZURlZXAoZGVmaW5pdGlvbi5kZWZhdWx0VmFsdWUpXG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBpZiAob3B0aW9ucy5nZXRBdXRvVmFsdWVzICYmIHR5cGVvZiBkZWZpbml0aW9uLmF1dG9WYWx1ZSA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgICAgcmVzdWx0ID0gZGVmaW5pdGlvbi5hdXRvVmFsdWUocmVzdWx0LCBvYmplY3QpXG4gICAgICAgIH1cblxuICAgICAgICBmb3IgKGxldCB0eXBlIG9mIF8ucmV2ZXJzZSh0eXBlcykgYXMgRGVmaW5pdGlvblR5cGVbXSkge1xuICAgICAgICAgICAgcmVzdWx0ID0gUm9vdFZhbGlkYXRvci5nZXRWYWxpZGF0b3IodHlwZSkuY2xlYW4oZGVmaW5pdGlvbiwgcmVzdWx0LCBvcHRpb25zLCBvYmplY3QpXG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gcmVzdWx0XG4gICAgfVxufVxuIl19
