"use strict";
var _ = require('lodash');
var composed_validation_result_1 = require('../composed-validation-result');
var string_validator_1 = require('./string-validator');
var number_validator_1 = require('./number-validator');
var date_validator_1 = require('./date-validator');
var object_validator_1 = require('./object-validator');
var schema_validator_1 = require('./schema-validator');
var boolean_validator_1 = require('./boolean-validator');
var schema_1 = require('../schema');
var cleaned_1 = require('../cleaned');
var RootValidator = (function () {
    function RootValidator() {
    }
    // for the type rule, the value is valid if at least one type is valid
    RootValidator.createTypeValidator = function (key, types, validatorsByType) {
        return function (value, object, options) {
            for (var _i = 0, types_1 = types; _i < types_1.length; _i++) {
                var type = types_1[_i];
                var validator = validatorsByType[type.name].type;
                if (validator(value, object, options) === null) {
                    return null;
                }
            }
            return {
                property: key,
                rule: 'type',
                message: "Property " + key + " must be one of [" + Object.keys(validatorsByType).join(', ') + "]"
            };
        };
    };
    // every other rule gets passed down to every typeValidator that supports the rule
    RootValidator.createRuleValidator = function (rule, types, validatorsByType) {
        return function (value, object, options) {
            for (var _i = 0, types_2 = types; _i < types_2.length; _i++) {
                var type = types_2[_i];
                var validator = validatorsByType[type.name][rule];
                if (typeof validator === 'function') {
                    return validator(value, object, options);
                }
            }
            return null;
        };
    };
    RootValidator.createArrayValidator = function (validator, key) {
        return function (value, object, options) {
            if (_.isArray(value)) {
                var result = new composed_validation_result_1.ComposedValidationResult();
                for (var index = 0; index < value.length; index++) {
                    result.and(validator(value[index], object, options), null, index);
                }
                return result;
            }
            return null;
        };
    };
    RootValidator.getValidatorsForKey = function (key, definition, options, object) {
        var validators = {};
        if (!definition.optional) {
            validators.required = cleaned_1.cleaned(RootValidator.RULES.required, key, definition, options);
        }
        if (definition.allowedValues) {
            validators.allowedValues = cleaned_1.cleaned(RootValidator.RULES.allowedValues, key, definition, options);
        }
        if (definition.array) {
            validators.isArray = cleaned_1.cleaned(RootValidator.RULES.isArray, key, definition, options);
        }
        if (typeof definition.minCount !== 'undefined') {
            validators.minCount = cleaned_1.cleaned(RootValidator.RULES.minCount, key, definition, options);
        }
        if (typeof definition.maxCount !== 'undefined') {
            validators.maxCount = cleaned_1.cleaned(RootValidator.RULES.maxCount, key, definition, options);
        }
        if (definition.custom) {
            if (typeof definition.custom === 'function') {
                validators.custom = cleaned_1.cleaned(RootValidator.RULES.custom, key, definition, options, object, definition.custom, 'custom');
            }
            else if (typeof definition.custom === 'object') {
                for (var rule in definition.custom) {
                    if (definition.custom.hasOwnProperty(rule)) {
                        validators[rule] = cleaned_1.cleaned(RootValidator.RULES.custom, key, definition, options, object, definition.custom[rule], rule);
                    }
                }
            }
        }
        var types = _.isArray(definition.type) ? definition.type : [definition.type];
        var validatorsByType = {};
        var rules = [];
        for (var _i = 0, types_3 = types; _i < types_3.length; _i++) {
            var type = types_3[_i];
            var validators_1 = this.getValidator(type).getValidatorsForKey(key, definition, options, object);
            validatorsByType[type.name] = validators_1;
            rules = _.union(rules, Object.keys(validators_1));
        }
        if (definition.array) {
            for (var _a = 0, rules_1 = rules; _a < rules_1.length; _a++) {
                var rule = rules_1[_a];
                validators[rule] = rule === 'type' ?
                    RootValidator.createArrayValidator(RootValidator.createTypeValidator(key, types, validatorsByType), key) :
                    RootValidator.createArrayValidator(RootValidator.createRuleValidator(rule, types, validatorsByType), key);
            }
        }
        else {
            for (var _b = 0, rules_2 = rules; _b < rules_2.length; _b++) {
                var rule = rules_2[_b];
                validators[rule] = rule === 'type' ?
                    RootValidator.createTypeValidator(key, types, validatorsByType) :
                    RootValidator.createRuleValidator(rule, types, validatorsByType);
            }
        }
        return validators;
    };
    RootValidator.getValidator = function (type) {
        switch (type) {
            case String:
                return string_validator_1.StringValidator;
            case Number:
                return number_validator_1.NumberValidator;
            case Date:
                return date_validator_1.DateValidator;
            case Object:
                return object_validator_1.ObjectValidator;
            case Boolean:
                return boolean_validator_1.BooleanValidator;
            default:
                if (type instanceof schema_1.Schema) {
                    return schema_validator_1.SchemaValidator;
                }
                else {
                    throw new Error("Unkown type " + type + " used in schema");
                }
        }
    };
    RootValidator.clean = function (definition, value, options, object) {
        var result = value;
        if (options.removeEmptyStrings && typeof result === 'string' && value.trim().length === 0) {
            if (definition.removeEmpty !== false) {
                result = null;
            }
        }
        else if (options.removeEmptyObjects && typeof result === 'object' && _.isEmpty(result) && !_.isDate(result)) {
            if (definition.removeEmpty !== false) {
                result = null;
            }
        }
        var types = Array.isArray(definition.type) ? definition.type : [definition.type];
        if (typeof result === 'undefined' || result == null) {
            if (typeof definition.defaultValue !== 'undefined') {
                result = _.cloneDeep(definition.defaultValue);
            }
        }
        if (options.getAutoValues && typeof definition.autoValue === 'function') {
            result = definition.autoValue(result, object);
        }
        for (var _i = 0, _a = _.reverse(types); _i < _a.length; _i++) {
            var type = _a[_i];
            result = RootValidator.getValidator(type).clean(definition, result, options, object);
        }
        return result;
    };
    RootValidator.RULES = {
        isArray: function (value, key, definition) {
            if ((typeof value !== 'undefined' && value !== null) && !Array.isArray(value)) {
                return {
                    property: key,
                    rule: 'type',
                    message: "Property " + key + " expected to be an array of type " + definition.type.name
                };
            }
            return null;
        },
        minCount: function (value, key, definition) {
            if ((typeof value !== 'undefined' && value !== null) && (typeof definition.minCount === 'number') && value.length < definition.minCount) {
                return {
                    property: key,
                    rule: 'minCount',
                    message: "Property " + key + " expected to be an array of type " + definition.type.name + " with at least " + definition.minCount + " elements"
                };
            }
            return null;
        },
        maxCount: function (value, key, definition) {
            if ((typeof value !== 'undefined' && value !== null) && (typeof definition.maxCount === 'number') && value.length > definition.maxCount) {
                return {
                    property: key,
                    rule: 'maxCount',
                    message: "Property " + key + " expected to be an array of type " + definition.type.name + " with at max " + definition.maxCount + " elements"
                };
            }
            return null;
        },
        required: function (value, key, definition) {
            if (!definition.optional && (typeof value === 'undefined' || value == null)) {
                return {
                    property: key,
                    rule: 'required',
                    message: "Missing value for property " + key
                };
            }
            return null;
        },
        allowedValues: function (value, key, definition) {
            if ((typeof value !== 'undefined' && value !== null) && typeof definition.allowedValues !== 'undefined') {
                if (definition.allowedValues.indexOf(value) === -1) {
                    return {
                        property: key,
                        rule: 'allowedValues',
                        message: "Value of " + key + " is not in allowedValues"
                    };
                }
            }
            return null;
        },
        custom: function (value, key, defintion, object, options, custom, rule) {
            var error = custom(value, object, options.context);
            if (typeof error === 'string') {
                return {
                    property: key,
                    rule: rule,
                    message: error
                };
            }
            return null;
        }
    };
    return RootValidator;
}());
exports.RootValidator = RootValidator;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInZhbGlkYXRvcnMvcm9vdC12YWxpZGF0b3IudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLElBQVksQ0FBQyxXQUFNLFFBRW5CLENBQUMsQ0FGMEI7QUFVM0IsMkNBQXlDLCtCQUN6QyxDQUFDLENBRHVFO0FBQ3hFLGlDQUFnQyxvQkFDaEMsQ0FBQyxDQURtRDtBQUNwRCxpQ0FBZ0Msb0JBQ2hDLENBQUMsQ0FEbUQ7QUFDcEQsK0JBQThCLGtCQUM5QixDQUFDLENBRCtDO0FBQ2hELGlDQUFnQyxvQkFDaEMsQ0FBQyxDQURtRDtBQUNwRCxpQ0FBZ0Msb0JBQ2hDLENBQUMsQ0FEbUQ7QUFDcEQsa0NBQWlDLHFCQUNqQyxDQUFDLENBRHFEO0FBQ3RELHVCQUF1QixXQUN2QixDQUFDLENBRGlDO0FBQ2xDLHdCQUF3QixZQUV4QixDQUFDLENBRm1DO0FBRXBDO0lBQUE7SUF3T0EsQ0FBQztJQWxLRyxzRUFBc0U7SUFDdkQsaUNBQW1CLEdBQWxDLFVBQW1DLEdBQVcsRUFBRSxLQUFpQixFQUFFLGdCQUFxQjtRQUNwRixNQUFNLENBQUMsVUFBQyxLQUFVLEVBQUUsTUFBWSxFQUFFLE9BQTJCO1lBQ3pELEdBQUcsQ0FBQyxDQUFhLFVBQUssRUFBTCxlQUFLLEVBQUwsbUJBQUssRUFBTCxJQUFLLENBQUM7Z0JBQWxCLElBQUksSUFBSSxjQUFBO2dCQUNULElBQU0sU0FBUyxHQUFHLGdCQUFnQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUE7Z0JBQ2xELEVBQUUsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxLQUFLLEVBQUUsTUFBTSxFQUFFLE9BQU8sQ0FBQyxLQUFLLElBQUksQ0FBQyxDQUFDLENBQUM7b0JBQzdDLE1BQU0sQ0FBQyxJQUFJLENBQUE7Z0JBQ2YsQ0FBQzthQUNKO1lBQ0QsTUFBTSxDQUFDO2dCQUNILFFBQVEsRUFBRSxHQUFHO2dCQUNiLElBQUksRUFBRSxNQUFNO2dCQUNaLE9BQU8sRUFBRSxjQUFZLEdBQUcseUJBQW9C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eE9BLEFBd09DLElBQUE7QUF4T1kscUJBQWEsZ0JBd096QixDQUFBIiwiZmlsZSI6InZhbGlkYXRvcnMvcm9vdC12YWxpZGF0b3IuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBfIGZyb20gJ2xvZGFzaCdcblxuaW1wb3J0IHtcbiAgICBWYWxpZGF0aW9uRGVmaW5pdGlvbixcbiAgICBEZWZpbml0aW9uVHlwZSxcbiAgICBWYWxpZGF0aW9uUmVzdWx0LFxuICAgIFZhbGlkYXRpb25PcHRpb25zLFxuICAgIFZhbGlkYXRpb25FcnJvcixcbiAgICBDbGVhbk9wdGlvbnNcbn0gZnJvbSAnLi4vaW50ZXJmYWNlcydcbmltcG9ydCB7IENvbXBvc2VkVmFsaWRhdGlvblJlc3VsdCB9IGZyb20gJy4uL2NvbXBvc2VkLXZhbGlkYXRpb24tcmVzdWx0J1xuaW1wb3J0IHsgU3RyaW5nVmFsaWRhdG9yIH0gZnJvbSAnLi9zdHJpbmctdmFsaWRhdG9yJ1xuaW1wb3J0IHsgTnVtYmVyVmFsaWRhdG9yIH0gZnJvbSAnLi9udW1iZXItdmFsaWRhdG9yJ1xuaW1wb3J0IHsgRGF0ZVZhbGlkYXRvciB9IGZyb20gJy4vZGF0ZS12YWxpZGF0b3InXG5pbXBvcnQgeyBPYmplY3RWYWxpZGF0b3IgfSBmcm9tICcuL29iamVjdC12YWxpZGF0b3InXG5pbXBvcnQgeyBTY2hlbWFWYWxpZGF0b3IgfSBmcm9tICcuL3NjaGVtYS12YWxpZGF0b3InXG5pbXBvcnQgeyBCb29sZWFuVmFsaWRhdG9yIH0gZnJvbSAnLi9ib29sZWFuLXZhbGlkYXRvcidcbmltcG9ydCB7IFNjaGVtYSB9IGZyb20gJy4uL3NjaGVtYSdcbmltcG9ydCB7IGNsZWFuZWQgfSBmcm9tICcuLi9jbGVhbmVkJ1xuXG5leHBvcnQgY2xhc3MgUm9vdFZhbGlkYXRvciB7XG5cbiAgICBwdWJsaWMgc3RhdGljIFJVTEVTID0ge1xuICAgICAgICBpc0FycmF5OiAodmFsdWU6IGFueSwga2V5OiBzdHJpbmcsIGRlZmluaXRpb246IFZhbGlkYXRpb25EZWZpbml0aW9uKTogVmFsaWRhdGlvbkVycm9yIHwgbnVsbCA9PiB7XG4gICAgICAgICAgICBpZiAoKHR5cGVvZiB2YWx1ZSAhPT0gJ3VuZGVmaW5lZCcgJiYgdmFsdWUgIT09IG51bGwpICYmICFBcnJheS5pc0FycmF5KHZhbHVlKSkge1xuICAgICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgICAgIHByb3BlcnR5OiBrZXksXG4gICAgICAgICAgICAgICAgICAgIHJ1bGU6ICd0eXBlJyxcbiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZTogYFByb3BlcnR5ICR7a2V5fSBleHBlY3RlZCB0byBiZSBhbiBhcnJheSBvZiB0eXBlICR7ZGVmaW5pdGlvbi50eXBlLm5hbWV9YFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBudWxsXG4gICAgICAgIH0sXG4gICAgICAgIG1pbkNvdW50OiAodmFsdWU6IGFueSwga2V5OiBzdHJpbmcsIGRlZmluaXRpb246IFZhbGlkYXRpb25EZWZpbml0aW9uKTogVmFsaWRhdGlvbkVycm9yIHwgbnVsbCA9PiB7XG4gICAgICAgICAgICBpZiAoKHR5cGVvZiB2YWx1ZSAhPT0gJ3VuZGVmaW5lZCcgJiYgdmFsdWUgIT09IG51bGwpICYmICh0eXBlb2YgZGVmaW5pdGlvbi5taW5Db3VudCA9PT0gJ251bWJlcicpICYmIHZhbHVlLmxlbmd0aCA8IGRlZmluaXRpb24ubWluQ291bnQpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgICAgICBwcm9wZXJ0eToga2V5LFxuICAgICAgICAgICAgICAgICAgICBydWxlOiAnbWluQ291bnQnLFxuICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiBgUHJvcGVydHkgJHtrZXl9IGV4cGVjdGVkIHRvIGJlIGFuIGFycmF5IG9mIHR5cGUgJHtkZWZpbml0aW9uLnR5cGUubmFtZX0gd2l0aCBhdCBsZWFzdCAke2RlZmluaXRpb24ubWluQ291bnR9IGVsZW1lbnRzYFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIG51bGxcbiAgICAgICAgfSxcbiAgICAgICAgbWF4Q291bnQ6ICh2YWx1ZTogYW55LCBrZXk6IHN0cmluZywgZGVmaW5pdGlvbjogVmFsaWRhdGlvbkRlZmluaXRpb24pOiBWYWxpZGF0aW9uRXJyb3IgfCBudWxsID0+IHtcbiAgICAgICAgICAgIGlmICgodHlwZW9mIHZhbHVlICE9PSAndW5kZWZpbmVkJyAmJiB2YWx1ZSAhPT0gbnVsbCkgJiYgKHR5cGVvZiBkZWZpbml0aW9uLm1heENvdW50ID09PSAnbnVtYmVyJykgJiYgdmFsdWUubGVuZ3RoID4gZGVmaW5pdGlvbi5tYXhDb3VudCkge1xuICAgICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgICAgIHByb3BlcnR5OiBrZXksXG4gICAgICAgICAgICAgICAgICAgIHJ1bGU6ICdtYXhDb3VudCcsXG4gICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IGBQcm9wZXJ0eSAke2tleX0gZXhwZWN0ZWQgdG8gYmUgYW4gYXJyYXkgb2YgdHlwZSAke2RlZmluaXRpb24udHlwZS5uYW1lfSB3aXRoIGF0IG1heCAke2RlZmluaXRpb24ubWF4Q291bnR9IGVsZW1lbnRzYFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBudWxsXG4gICAgICAgIH0sXG4gICAgICAgIHJlcXVpcmVkOiAodmFsdWU6IGFueSwga2V5OiBzdHJpbmcsIGRlZmluaXRpb246IFZhbGlkYXRpb25EZWZpbml0aW9uKTogVmFsaWRhdGlvbkVycm9yIHwgbnVsbCA9PiB7XG4gICAgICAgICAgICBpZiAoIWRlZmluaXRpb24ub3B0aW9uYWwgJiYgKHR5cGVvZiB2YWx1ZSA9PT0gJ3VuZGVmaW5lZCcgfHwgdmFsdWUgPT0gbnVsbCkpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgICAgICBwcm9wZXJ0eToga2V5LFxuICAgICAgICAgICAgICAgICAgICBydWxlOiAncmVxdWlyZWQnLFxuICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiBgTWlzc2luZyB2YWx1ZSBmb3IgcHJvcGVydHkgJHtrZXl9YFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBudWxsXG4gICAgICAgIH0sXG4gICAgICAgIGFsbG93ZWRWYWx1ZXM6ICh2YWx1ZTogYW55LCBrZXk6IHN0cmluZywgZGVmaW5pdGlvbjogVmFsaWRhdGlvbkRlZmluaXRpb24pOiBWYWxpZGF0aW9uRXJyb3IgfCBudWxsID0+IHtcbiAgICAgICAgICAgIGlmICgodHlwZW9mIHZhbHVlICE9PSAndW5kZWZpbmVkJyAmJiB2YWx1ZSAhPT0gbnVsbCkgJiYgdHlwZW9mIGRlZmluaXRpb24uYWxsb3dlZFZhbHVlcyAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICAgICAgICBpZiAoZGVmaW5pdGlvbi5hbGxvd2VkVmFsdWVzLmluZGV4T2YodmFsdWUpID09PSAtMSkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgcHJvcGVydHk6IGtleSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHJ1bGU6ICdhbGxvd2VkVmFsdWVzJyxcbiAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IGBWYWx1ZSBvZiAke2tleX0gaXMgbm90IGluIGFsbG93ZWRWYWx1ZXNgXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gbnVsbFxuICAgICAgICB9LFxuICAgICAgICBjdXN0b206ICh2YWx1ZTogYW55LCBrZXk6IHN0cmluZywgZGVmaW50aW9uOiBWYWxpZGF0aW9uRGVmaW5pdGlvbiwgb2JqZWN0OiBhbnksIG9wdGlvbnM6IFZhbGlkYXRpb25PcHRpb25zLCBjdXN0b206IEZ1bmN0aW9uLCBydWxlOiBzdHJpbmcpOiBWYWxpZGF0aW9uRXJyb3IgfCBudWxsID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGVycm9yID0gY3VzdG9tKHZhbHVlLCBvYmplY3QsIG9wdGlvbnMuY29udGV4dClcblxuICAgICAgICAgICAgaWYgKHR5cGVvZiBlcnJvciA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgICAgICBwcm9wZXJ0eToga2V5LFxuICAgICAgICAgICAgICAgICAgICBydWxlOiBydWxlLFxuICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiBlcnJvclxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBudWxsXG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBmb3IgdGhlIHR5cGUgcnVsZSwgdGhlIHZhbHVlIGlzIHZhbGlkIGlmIGF0IGxlYXN0IG9uZSB0eXBlIGlzIHZhbGlkXG4gICAgcHJpdmF0ZSBzdGF0aWMgY3JlYXRlVHlwZVZhbGlkYXRvcihrZXk6IHN0cmluZywgdHlwZXM6IEZ1bmN0aW9uW10sIHZhbGlkYXRvcnNCeVR5cGU6IGFueSkge1xuICAgICAgICByZXR1cm4gKHZhbHVlOiBhbnksIG9iamVjdD86IGFueSwgb3B0aW9ucz86IFZhbGlkYXRpb25PcHRpb25zKSA9PiB7XG4gICAgICAgICAgICBmb3IgKGxldCB0eXBlIG9mIHR5cGVzKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgdmFsaWRhdG9yID0gdmFsaWRhdG9yc0J5VHlwZVt0eXBlLm5hbWVdLnR5cGVcbiAgICAgICAgICAgICAgICBpZiAodmFsaWRhdG9yKHZhbHVlLCBvYmplY3QsIG9wdGlvbnMpID09PSBudWxsKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICBwcm9wZXJ0eToga2V5LFxuICAgICAgICAgICAgICAgIHJ1bGU6ICd0eXBlJyxcbiAgICAgICAgICAgICAgICBtZXNzYWdlOiBgUHJvcGVydHkgJHtrZXl9IG11c3QgYmUgb25lIG9mIFske09iamVjdC5rZXlzKHZhbGlkYXRvcnNCeVR5cGUpLmpvaW4oJywgJyl9XWBcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8vIGV2ZXJ5IG90aGVyIHJ1bGUgZ2V0cyBwYXNzZWQgZG93biB0byBldmVyeSB0eXBlVmFsaWRhdG9yIHRoYXQgc3VwcG9ydHMgdGhlIHJ1bGVcbiAgICBwcml2YXRlIHN0YXRpYyBjcmVhdGVSdWxlVmFsaWRhdG9yKHJ1bGU6IHN0cmluZywgdHlwZXM6IEZ1bmN0aW9uW10sIHZhbGlkYXRvcnNCeVR5cGU6IGFueSkge1xuICAgICAgICByZXR1cm4gKHZhbHVlOiBhbnksIG9iamVjdD86IGFueSwgb3B0aW9ucz86IFZhbGlkYXRpb25PcHRpb25zKSA9PiB7XG4gICAgICAgICAgICBmb3IgKGxldCB0eXBlIG9mIHR5cGVzKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgdmFsaWRhdG9yID0gdmFsaWRhdG9yc0J5VHlwZVt0eXBlLm5hbWVdW3J1bGVdXG5cbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHZhbGlkYXRvciA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsaWRhdG9yKHZhbHVlLCBvYmplY3QsIG9wdGlvbnMpXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIG51bGxcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgc3RhdGljIGNyZWF0ZUFycmF5VmFsaWRhdG9yKHZhbGlkYXRvcjogKHZhbHVlOiBhbnksIG9iamVjdD86IGFueSwgb3B0aW9ucz86IFZhbGlkYXRpb25PcHRpb25zKSA9PiBhbnksIGtleTogc3RyaW5nKSB7XG4gICAgICAgIHJldHVybiAodmFsdWU6IGFueSwgb2JqZWN0PzogYW55LCBvcHRpb25zPzogVmFsaWRhdGlvbk9wdGlvbnMpID0+IHtcbiAgICAgICAgICAgIGlmIChfLmlzQXJyYXkodmFsdWUpKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gbmV3IENvbXBvc2VkVmFsaWRhdGlvblJlc3VsdCgpXG4gICAgICAgICAgICAgICAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IHZhbHVlLmxlbmd0aDsgaW5kZXgrKykge1xuICAgICAgICAgICAgICAgICAgICByZXN1bHQuYW5kKHZhbGlkYXRvcih2YWx1ZVtpbmRleF0sIG9iamVjdCwgb3B0aW9ucyksIG51bGwsIGluZGV4KVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gbnVsbFxuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIHN0YXRpYyBnZXRWYWxpZGF0b3JzRm9yS2V5KGtleTogc3RyaW5nLCBkZWZpbml0aW9uOiBWYWxpZGF0aW9uRGVmaW5pdGlvbiwgb3B0aW9uczogVmFsaWRhdGlvbk9wdGlvbnMsIG9iamVjdD86IGFueSkge1xuICAgICAgICBjb25zdCB2YWxpZGF0b3JzOiBhbnkgPSB7fVxuXG4gICAgICAgIGlmICghZGVmaW5pdGlvbi5vcHRpb25hbCkge1xuICAgICAgICAgICAgdmFsaWRhdG9ycy5yZXF1aXJlZCA9IGNsZWFuZWQoUm9vdFZhbGlkYXRvci5SVUxFUy5yZXF1aXJlZCwga2V5LCBkZWZpbml0aW9uLCBvcHRpb25zKVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGRlZmluaXRpb24uYWxsb3dlZFZhbHVlcykge1xuICAgICAgICAgICAgdmFsaWRhdG9ycy5hbGxvd2VkVmFsdWVzID0gY2xlYW5lZChSb290VmFsaWRhdG9yLlJVTEVTLmFsbG93ZWRWYWx1ZXMsIGtleSwgZGVmaW5pdGlvbiwgb3B0aW9ucylcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChkZWZpbml0aW9uLmFycmF5KSB7XG4gICAgICAgICAgICB2YWxpZGF0b3JzLmlzQXJyYXkgPSBjbGVhbmVkKFJvb3RWYWxpZGF0b3IuUlVMRVMuaXNBcnJheSwga2V5LCBkZWZpbml0aW9uLCBvcHRpb25zKVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHR5cGVvZiBkZWZpbml0aW9uLm1pbkNvdW50ICE9PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgdmFsaWRhdG9ycy5taW5Db3VudCA9IGNsZWFuZWQoUm9vdFZhbGlkYXRvci5SVUxFUy5taW5Db3VudCwga2V5LCBkZWZpbml0aW9uLCBvcHRpb25zKVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHR5cGVvZiBkZWZpbml0aW9uLm1heENvdW50ICE9PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgdmFsaWRhdG9ycy5tYXhDb3VudCA9IGNsZWFuZWQoUm9vdFZhbGlkYXRvci5SVUxFUy5tYXhDb3VudCwga2V5LCBkZWZpbml0aW9uLCBvcHRpb25zKVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGRlZmluaXRpb24uY3VzdG9tKSAge1xuICAgICAgICAgICAgaWYgKHR5cGVvZiBkZWZpbml0aW9uLmN1c3RvbSA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgICAgICAgIHZhbGlkYXRvcnMuY3VzdG9tID0gY2xlYW5lZChSb290VmFsaWRhdG9yLlJVTEVTLmN1c3RvbSwga2V5LCBkZWZpbml0aW9uLCBvcHRpb25zLCBvYmplY3QsIGRlZmluaXRpb24uY3VzdG9tLCAnY3VzdG9tJylcbiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGRlZmluaXRpb24uY3VzdG9tID09PSAnb2JqZWN0Jykge1xuICAgICAgICAgICAgICAgIGZvciAobGV0IHJ1bGUgaW4gZGVmaW5pdGlvbi5jdXN0b20pIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGRlZmluaXRpb24uY3VzdG9tLmhhc093blByb3BlcnR5KHJ1bGUpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YWxpZGF0b3JzW3J1bGVdID0gY2xlYW5lZChSb290VmFsaWRhdG9yLlJVTEVTLmN1c3RvbSwga2V5LCBkZWZpbml0aW9uLCBvcHRpb25zLCBvYmplY3QsIGRlZmluaXRpb24uY3VzdG9tW3J1bGVdLCBydWxlKVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cblxuICAgICAgICBjb25zdCB0eXBlcyA9IF8uaXNBcnJheTxEZWZpbml0aW9uVHlwZT4oZGVmaW5pdGlvbi50eXBlKSA/IGRlZmluaXRpb24udHlwZSA6IFtkZWZpbml0aW9uLnR5cGVdXG5cbiAgICAgICAgY29uc3QgdmFsaWRhdG9yc0J5VHlwZTogYW55ID0ge31cbiAgICAgICAgbGV0IHJ1bGVzOiBhbnlbXSA9IFtdXG5cbiAgICAgICAgZm9yIChsZXQgdHlwZSBvZiB0eXBlcykge1xuICAgICAgICAgICAgY29uc3QgdmFsaWRhdG9ycyA9IHRoaXMuZ2V0VmFsaWRhdG9yKHR5cGUpLmdldFZhbGlkYXRvcnNGb3JLZXkoa2V5LCBkZWZpbml0aW9uLCBvcHRpb25zLCBvYmplY3QpXG4gICAgICAgICAgICB2YWxpZGF0b3JzQnlUeXBlW3R5cGUubmFtZV0gPSB2YWxpZGF0b3JzXG4gICAgICAgICAgICBydWxlcyA9IF8udW5pb24ocnVsZXMsIE9iamVjdC5rZXlzKHZhbGlkYXRvcnMpKVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGRlZmluaXRpb24uYXJyYXkpIHtcbiAgICAgICAgICAgIGZvciAobGV0IHJ1bGUgb2YgcnVsZXMpIHtcbiAgICAgICAgICAgICAgICB2YWxpZGF0b3JzW3J1bGVdID0gcnVsZSA9PT0gJ3R5cGUnID9cbiAgICAgICAgICAgICAgICAgICAgUm9vdFZhbGlkYXRvci5jcmVhdGVBcnJheVZhbGlkYXRvcihSb290VmFsaWRhdG9yLmNyZWF0ZVR5cGVWYWxpZGF0b3Ioa2V5LCB0eXBlcywgdmFsaWRhdG9yc0J5VHlwZSksIGtleSkgOlxuICAgICAgICAgICAgICAgICAgICBSb290VmFsaWRhdG9yLmNyZWF0ZUFycmF5VmFsaWRhdG9yKFJvb3RWYWxpZGF0b3IuY3JlYXRlUnVsZVZhbGlkYXRvcihydWxlLCB0eXBlcywgdmFsaWRhdG9yc0J5VHlwZSksIGtleSlcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGZvciAobGV0IHJ1bGUgb2YgcnVsZXMpIHtcbiAgICAgICAgICAgICAgICB2YWxpZGF0b3JzW3J1bGVdID0gcnVsZSA9PT0gJ3R5cGUnID9cbiAgICAgICAgICAgICAgICAgICAgUm9vdFZhbGlkYXRvci5jcmVhdGVUeXBlVmFsaWRhdG9yKGtleSwgdHlwZXMsIHZhbGlkYXRvcnNCeVR5cGUpIDpcbiAgICAgICAgICAgICAgICAgICAgUm9vdFZhbGlkYXRvci5jcmVhdGVSdWxlVmFsaWRhdG9yKHJ1bGUsIHR5cGVzLCB2YWxpZGF0b3JzQnlUeXBlKVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHZhbGlkYXRvcnNcbiAgICB9XG5cbiAgICBwdWJsaWMgc3RhdGljIGdldFZhbGlkYXRvcih0eXBlOiBEZWZpbml0aW9uVHlwZSk6IHtcbiAgICAgICAgICAgIGdldFZhbGlkYXRvcnNGb3JLZXk6IChrZXk6IHN0cmluZywgZGVmaW5pdGlvbjogVmFsaWRhdGlvbkRlZmluaXRpb24sIG9wdGlvbnM6IFZhbGlkYXRpb25PcHRpb25zLCBvYmplY3Q6IGFueSkgPT4gYW55LFxuICAgICAgICAgICAgY2xlYW46IChkZWZpbml0aW9uOiBWYWxpZGF0aW9uRGVmaW5pdGlvbiwgdmFsdWU6IGFueSwgb3B0aW9uczogQ2xlYW5PcHRpb25zLCBvYmplY3Q6IGFueSkgPT4gYW55XG4gICAgfSB7XG4gICAgICAgIHN3aXRjaCAodHlwZSkge1xuICAgICAgICAgICAgY2FzZSBTdHJpbmc6XG4gICAgICAgICAgICAgICAgcmV0dXJuIFN0cmluZ1ZhbGlkYXRvclxuICAgICAgICAgICAgY2FzZSBOdW1iZXI6XG4gICAgICAgICAgICAgICAgcmV0dXJuIE51bWJlclZhbGlkYXRvclxuICAgICAgICAgICAgY2FzZSBEYXRlOlxuICAgICAgICAgICAgICAgIHJldHVybiBEYXRlVmFsaWRhdG9yXG4gICAgICAgICAgICBjYXNlIE9iamVjdDpcbiAgICAgICAgICAgICAgICByZXR1cm4gT2JqZWN0VmFsaWRhdG9yXG4gICAgICAgICAgICBjYXNlIEJvb2xlYW46XG4gICAgICAgICAgICAgICAgcmV0dXJuIEJvb2xlYW5WYWxpZGF0b3JcbiAgICAgICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICAgICAgaWYgKHR5cGUgaW5zdGFuY2VvZiBTY2hlbWEpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFNjaGVtYVZhbGlkYXRvclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgVW5rb3duIHR5cGUgJHt0eXBlfSB1c2VkIGluIHNjaGVtYWApXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIHN0YXRpYyBjbGVhbihkZWZpbml0aW9uOiBWYWxpZGF0aW9uRGVmaW5pdGlvbiwgdmFsdWU6IGFueSwgb3B0aW9uczogQ2xlYW5PcHRpb25zLCBvYmplY3Q6IGFueSk6IGFueSB7XG4gICAgICAgIGxldCByZXN1bHQ6IGFueSA9IHZhbHVlXG5cbiAgICAgICAgaWYgKG9wdGlvbnMucmVtb3ZlRW1wdHlTdHJpbmdzICYmIHR5cGVvZiByZXN1bHQgPT09ICdzdHJpbmcnICYmIHZhbHVlLnRyaW0oKS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgIGlmIChkZWZpbml0aW9uLnJlbW92ZUVtcHR5ICE9PSBmYWxzZSkge1xuICAgICAgICAgICAgICAgIHJlc3VsdCA9IG51bGxcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIGlmIChvcHRpb25zLnJlbW92ZUVtcHR5T2JqZWN0cyAmJiB0eXBlb2YgcmVzdWx0ID09PSAnb2JqZWN0JyAmJiBfLmlzRW1wdHkocmVzdWx0KSAmJiAhXy5pc0RhdGUocmVzdWx0KSkge1xuICAgICAgICAgICAgaWYgKGRlZmluaXRpb24ucmVtb3ZlRW1wdHkgIT09IGZhbHNlKSB7XG4gICAgICAgICAgICAgICAgcmVzdWx0ID0gbnVsbFxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHR5cGVzOiBEZWZpbml0aW9uVHlwZVtdID0gQXJyYXkuaXNBcnJheShkZWZpbml0aW9uLnR5cGUpID8gKGRlZmluaXRpb24udHlwZSBhcyBEZWZpbml0aW9uVHlwZVtdKSA6IFtkZWZpbml0aW9uLnR5cGUgYXMgRGVmaW5pdGlvblR5cGVdXG5cbiAgICAgICAgaWYgKHR5cGVvZiByZXN1bHQgPT09ICd1bmRlZmluZWQnIHx8IHJlc3VsdCA9PSBudWxsKSB7XG4gICAgICAgICAgICBpZiAodHlwZW9mIGRlZmluaXRpb24uZGVmYXVsdFZhbHVlICE9PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgICAgIHJlc3VsdCA9IF8uY2xvbmVEZWVwKGRlZmluaXRpb24uZGVmYXVsdFZhbHVlKVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKG9wdGlvbnMuZ2V0QXV0b1ZhbHVlcyAmJiB0eXBlb2YgZGVmaW5pdGlvbi5hdXRvVmFsdWUgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgICAgIHJlc3VsdCA9IGRlZmluaXRpb24uYXV0b1ZhbHVlKHJlc3VsdCwgb2JqZWN0KVxuICAgICAgICB9XG5cbiAgICAgICAgZm9yIChsZXQgdHlwZSBvZiBfLnJldmVyc2UodHlwZXMpIGFzIERlZmluaXRpb25UeXBlW10pIHtcbiAgICAgICAgICAgIHJlc3VsdCA9IFJvb3RWYWxpZGF0b3IuZ2V0VmFsaWRhdG9yKHR5cGUpLmNsZWFuKGRlZmluaXRpb24sIHJlc3VsdCwgb3B0aW9ucywgb2JqZWN0KVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHJlc3VsdFxuICAgIH1cbn1cbiJdfQ==
