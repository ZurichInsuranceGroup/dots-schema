"use strict";
var _ = require('lodash');
var composed_validation_result_1 = require('./composed-validation-result');
var root_validator_1 = require('./validators/root-validator');
var Schema = (function () {
    function Schema(schema, options) {
        if (options === void 0) { options = {}; }
        this.schema = schema;
        this.options = options;
        _.defaults(options, Schema.DefaultOptions);
    }
    Schema.prototype.cleanKey = function (key, object, options) {
        if (options === void 0) { options = {}; }
        var definition = this.schema[key];
        if (definition.type instanceof Function || definition.type instanceof Schema || _.isObject(definition.type)) {
            return root_validator_1.RootValidator.clean(definition, object[key], options, object);
        }
        else {
            throw new Error("Invalid type '" + definition.type + "' used in " + this.name);
        }
    };
    Schema.prototype.validate = function (object, key, options) {
        if (typeof key === 'string') {
            options = _.defaults({}, options, Schema.DefaultOptions);
            var validator = this.getValidator(key, object, options);
            if (options.clean) {
                var cleanOptions = _.defaults({}, options.clean, Schema.DefaultCleanOptions);
                object = this.clean(object, cleanOptions);
            }
            return validator(object, options);
        }
        else {
            options = _.defaults({}, key, Schema.DefaultOptions);
            var validator = this.getValidator(object, options);
            if (options.clean) {
                var cleanOptions = _.defaults({}, options.clean, Schema.DefaultCleanOptions);
                object = this.clean(object, cleanOptions);
            }
            return validator(object, options);
        }
    };
    Schema.prototype.clean = function (object, options) {
        if (options === void 0) { options = {}; }
        if (typeof object === 'undefined' || object === null) {
            return object;
        }
        _.defaults(options, Schema.DefaultCleanOptions);
        var result = options.mutate ? object : _.cloneDeep(object);
        for (var key in this.schema) {
            if (this.schema.hasOwnProperty(key)) {
                result[key] = this.cleanKey(key, object, options);
            }
        }
        return result;
    };
    Schema.prototype.extend = function (schema) {
        return this;
    };
    Schema.prototype._getValidators = function (object, options) {
        options = typeof options === 'object' ? _.defaults(options, this.options) : this.options;
        var validators = {};
        for (var key in this.schema) {
            if (this.schema.hasOwnProperty(key)) {
                var keyValidators = {};
                _.assign(keyValidators, root_validator_1.RootValidator.getValidatorsForKey(key, this.schema[key], options, object));
                validators[key] = keyValidators;
            }
        }
        return validators;
    };
    Schema.prototype._getValidatorsForKey = function (key, object, options) {
        options = typeof options === 'object' ? _.defaults(options, this.options) : this.options;
        return root_validator_1.RootValidator.getValidatorsForKey(key, this.schema[key], options, object);
    };
    Schema.prototype.getValidators = function (key, object, options) {
        if (typeof key === 'string') {
            return this._getValidatorsForKey(key, object, options);
        }
        else {
            return this._getValidators(key, object);
        }
    };
    Schema.prototype._getValidatorForKey = function (property, object, options) {
        var validators = this.getValidators(object, options);
        return function (value, object, options) {
            object = object ? object : value;
            var result = new composed_validation_result_1.ComposedValidationResult();
            if (validators.hasOwnProperty(property)) {
                var propertyValidators = validators[property];
                for (var rule in propertyValidators) {
                    if (propertyValidators.hasOwnProperty(rule)) {
                        var validator = propertyValidators[rule];
                        var error = validator(value[property], object, options);
                        if (typeof error === 'string') {
                            result.and({
                                property: property,
                                rule: rule,
                                message: error
                            });
                        }
                        else if (typeof error === 'object') {
                            result.and(error);
                        }
                    }
                }
            }
            return result.isValid() ? null : result;
        };
    };
    Schema.prototype._getValidator = function (object, options) {
        var validators = this.getValidators(object, options);
        return function (value, object, options) {
            object = object ? object : value;
            var result = new composed_validation_result_1.ComposedValidationResult();
            for (var property in validators) {
                if (validators.hasOwnProperty(property)) {
                    var propertyValidators = validators[property];
                    for (var rule in propertyValidators) {
                        if (propertyValidators.hasOwnProperty(rule)) {
                            var validator = propertyValidators[rule];
                            var error = validator(value[property], object, options);
                            if (typeof error === 'string') {
                                result.and({
                                    property: property,
                                    rule: rule,
                                    message: error
                                });
                            }
                            else if (typeof error === 'object') {
                                result.and(error);
                            }
                        }
                    }
                }
            }
            return result.isValid() ? null : result;
        };
    };
    Schema.prototype.getValidator = function (key, object, options) {
        if (typeof key === 'string') {
            return this._getValidatorForKey(key, object, options);
        }
        else {
            return this._getValidator(key, object);
        }
    };
    Schema.DefaultOptions = {
        name: 'Schema',
        clean: false,
        strict: false,
        context: {}
    };
    Schema.DefaultCleanOptions = {
        mutate: false,
        trimStrings: true,
        removeEmptyStrings: true,
        removeEmptyObjects: true,
        rounding: 'round',
        filter: false,
        autoConvert: true,
        getAutoValues: true
    };
    Schema.RegEx = {
        Email: /^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/
    };
    return Schema;
}());
exports.Schema = Schema;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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SUFBSTtRQUN4QixrQkFBa0IsRUFBRSxJQUFJO1FBQ3hCLFFBQVEsRUFBRSxPQUFPO1FBQ2pCLE1BQU0sRUFBRSxLQUFLO1FBQ2IsV0FBVyxFQUFFLElBQUk7UUFDakIsYUFBYSxFQUFFLElBQUk7S0FDdEIsQ0FBQTtJQUVNLFlBQUssR0FBRztRQUNYLEtBQUssRUFBRSxzSUFBc0k7S0FDaEosQ0FBQTtJQXlKTCxhQUFDO0FBQUQsQ0FqTEEsQUFpTEMsSUFBQTtBQWpMWSxjQUFNLFNBaUxsQixDQUFBIiwiZmlsZSI6InNjaGVtYS5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIF8gZnJvbSAnbG9kYXNoJ1xuXG5pbXBvcnQge1xuICAgIFZhbGlkYXRpb25PcHRpb25zLFxuICAgIFZhbGlkYXRpb25SZXN1bHQsXG4gICAgVmFsaWRhdGlvbkRlZmluaXRpb24sXG4gICAgQ2xlYW5PcHRpb25zXG59IGZyb20gJy4vaW50ZXJmYWNlcydcbmltcG9ydCB7IENvbXBvc2VkVmFsaWRhdGlvblJlc3VsdH0gZnJvbSAnLi9jb21wb3NlZC12YWxpZGF0aW9uLXJlc3VsdCdcbmltcG9ydCB7IFJvb3RWYWxpZGF0b3IgfSBmcm9tICcuL3ZhbGlkYXRvcnMvcm9vdC12YWxpZGF0b3InXG5cbmV4cG9ydCBjbGFzcyBTY2hlbWEge1xuXG4gICAgcmVhZG9ubHkgbmFtZTogU3RyaW5nXG5cbiAgICBzdGF0aWMgRGVmYXVsdE9wdGlvbnM6IFZhbGlkYXRpb25PcHRpb25zID0ge1xuICAgICAgICBuYW1lOiAnU2NoZW1hJyxcbiAgICAgICAgY2xlYW46IGZhbHNlLFxuICAgICAgICBzdHJpY3Q6IGZhbHNlLFxuICAgICAgICBjb250ZXh0OiB7fVxuICAgIH1cblxuICAgIHN0YXRpYyBEZWZhdWx0Q2xlYW5PcHRpb25zOiBDbGVhbk9wdGlvbnMgPSB7XG4gICAgICAgIG11dGF0ZTogZmFsc2UsXG4gICAgICAgIHRyaW1TdHJpbmdzOiB0cnVlLFxuICAgICAgICByZW1vdmVFbXB0eVN0cmluZ3M6IHRydWUsXG4gICAgICAgIHJlbW92ZUVtcHR5T2JqZWN0czogdHJ1ZSxcbiAgICAgICAgcm91bmRpbmc6ICdyb3VuZCcsXG4gICAgICAgIGZpbHRlcjogZmFsc2UsXG4gICAgICAgIGF1dG9Db252ZXJ0OiB0cnVlLFxuICAgICAgICBnZXRBdXRvVmFsdWVzOiB0cnVlXG4gICAgfVxuXG4gICAgc3RhdGljIFJlZ0V4ID0ge1xuICAgICAgICBFbWFpbDogL15bYS16QS1aMC05LiEjJCUmJyorLz0/Xl9ge3x9fi1dK0BbYS16QS1aMC05XSg/OlthLXpBLVowLTktXXswLDYxfVthLXpBLVowLTldKT8oPzpcXC5bYS16QS1aMC05XSg/OlthLXpBLVowLTktXXswLDYxfVthLXpBLVowLTldKT8pKiQvXG4gICAgfVxuXG4gICAgY29uc3RydWN0b3IocHJvdGVjdGVkIHNjaGVtYTogYW55LCBwcml2YXRlIG9wdGlvbnM6IFZhbGlkYXRpb25PcHRpb25zID0ge30pIHtcbiAgICAgICAgXy5kZWZhdWx0cyhvcHRpb25zLCBTY2hlbWEuRGVmYXVsdE9wdGlvbnMpXG4gICAgfVxuXG4gICAgcHJpdmF0ZSBjbGVhbktleShrZXk6IHN0cmluZywgb2JqZWN0OiBhbnksIG9wdGlvbnM6IENsZWFuT3B0aW9ucyA9IHt9KSB7XG4gICAgICAgIGNvbnN0IGRlZmluaXRpb246IFZhbGlkYXRpb25EZWZpbml0aW9uID0gdGhpcy5zY2hlbWFba2V5XSBhcyBWYWxpZGF0aW9uRGVmaW5pdGlvblxuXG4gICAgICAgIGlmIChkZWZpbml0aW9uLnR5cGUgaW5zdGFuY2VvZiBGdW5jdGlvbiB8fCBkZWZpbml0aW9uLnR5cGUgaW5zdGFuY2VvZiBTY2hlbWEgfHwgXy5pc09iamVjdChkZWZpbml0aW9uLnR5cGUpKSB7XG4gICAgICAgICAgICByZXR1cm4gUm9vdFZhbGlkYXRvci5jbGVhbihkZWZpbml0aW9uLCBvYmplY3Rba2V5XSwgb3B0aW9ucywgb2JqZWN0KVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIHR5cGUgJyR7ZGVmaW5pdGlvbi50eXBlfScgdXNlZCBpbiAke3RoaXMubmFtZX1gKVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIHZhbGlkYXRlKG9iamVjdDogYW55LCBrZXk/OiBzdHJpbmcgfCBWYWxpZGF0aW9uT3B0aW9ucywgb3B0aW9ucz86IFZhbGlkYXRpb25PcHRpb25zKTogVmFsaWRhdGlvblJlc3VsdCB8IG51bGwge1xuICAgICAgICBpZiAodHlwZW9mIGtleSA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgICAgIG9wdGlvbnMgPSBfLmRlZmF1bHRzKHt9LCBvcHRpb25zLCBTY2hlbWEuRGVmYXVsdE9wdGlvbnMpXG5cbiAgICAgICAgICAgIGNvbnN0IHZhbGlkYXRvciA9IHRoaXMuZ2V0VmFsaWRhdG9yKGtleSwgb2JqZWN0LCBvcHRpb25zKVxuICAgICAgICAgICAgaWYgKG9wdGlvbnMuY2xlYW4pIHtcbiAgICAgICAgICAgICAgICBjb25zdCBjbGVhbk9wdGlvbnMgPSBfLmRlZmF1bHRzKHt9LCBvcHRpb25zLmNsZWFuLCBTY2hlbWEuRGVmYXVsdENsZWFuT3B0aW9ucylcbiAgICAgICAgICAgICAgICBvYmplY3QgPSB0aGlzLmNsZWFuKG9iamVjdCwgY2xlYW5PcHRpb25zKVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHZhbGlkYXRvcihvYmplY3QsIG9wdGlvbnMpXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBvcHRpb25zID0gXy5kZWZhdWx0cyh7fSwga2V5LCBTY2hlbWEuRGVmYXVsdE9wdGlvbnMpXG5cbiAgICAgICAgICAgIGNvbnN0IHZhbGlkYXRvciA9IHRoaXMuZ2V0VmFsaWRhdG9yKG9iamVjdCwgb3B0aW9ucylcbiAgICAgICAgICAgIGlmIChvcHRpb25zLmNsZWFuKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgY2xlYW5PcHRpb25zID0gXy5kZWZhdWx0cyh7fSwgb3B0aW9ucy5jbGVhbiwgU2NoZW1hLkRlZmF1bHRDbGVhbk9wdGlvbnMpXG4gICAgICAgICAgICAgICAgb2JqZWN0ID0gdGhpcy5jbGVhbihvYmplY3QsIGNsZWFuT3B0aW9ucylcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiB2YWxpZGF0b3Iob2JqZWN0LCBvcHRpb25zKVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIGNsZWFuKG9iamVjdDogYW55LCBvcHRpb25zOiBDbGVhbk9wdGlvbnMgPSB7fSk6IGFueSB7XG4gICAgICAgIGlmICh0eXBlb2Ygb2JqZWN0ID09PSAndW5kZWZpbmVkJyB8fCBvYmplY3QgPT09IG51bGwpIHtcbiAgICAgICAgICAgIHJldHVybiBvYmplY3RcbiAgICAgICAgfVxuICAgICAgICBfLmRlZmF1bHRzKG9wdGlvbnMsIFNjaGVtYS5EZWZhdWx0Q2xlYW5PcHRpb25zKVxuICAgICAgICBjb25zdCByZXN1bHQgPSBvcHRpb25zLm11dGF0ZSA/IG9iamVjdCA6IF8uY2xvbmVEZWVwKG9iamVjdClcblxuICAgICAgICBmb3IgKGxldCBrZXkgaW4gdGhpcy5zY2hlbWEpIHtcbiAgICAgICAgICAgIGlmICh0aGlzLnNjaGVtYS5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7XG4gICAgICAgICAgICAgICAgcmVzdWx0W2tleV0gPSB0aGlzLmNsZWFuS2V5KGtleSwgb2JqZWN0LCBvcHRpb25zKVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHJlc3VsdFxuICAgIH1cblxuICAgIHB1YmxpYyBleHRlbmQoc2NoZW1hOiBTY2hlbWEpOiBTY2hlbWEge1xuICAgICAgICByZXR1cm4gdGhpc1xuICAgIH1cblxuICAgIHByaXZhdGUgX2dldFZhbGlkYXRvcnMob2JqZWN0OiBhbnksIG9wdGlvbnM/OiBWYWxpZGF0aW9uT3B0aW9ucyk6IGFueSB7XG4gICAgICAgIG9wdGlvbnMgPSB0eXBlb2Ygb3B0aW9ucyA9PT0gJ29iamVjdCcgPyBfLmRlZmF1bHRzKG9wdGlvbnMsIHRoaXMub3B0aW9ucykgOiB0aGlzLm9wdGlvbnNcbiAgICAgICAgY29uc3QgdmFsaWRhdG9yczogYW55ID0ge31cbiAgICAgICAgZm9yIChsZXQga2V5IGluIHRoaXMuc2NoZW1hKSB7XG4gICAgICAgICAgICBpZiAodGhpcy5zY2hlbWEuaGFzT3duUHJvcGVydHkoa2V5KSkge1xuICAgICAgICAgICAgICAgIGNvbnN0IGtleVZhbGlkYXRvcnMgPSB7fVxuICAgICAgICAgICAgICAgIF8uYXNzaWduKGtleVZhbGlkYXRvcnMsIFJvb3RWYWxpZGF0b3IuZ2V0VmFsaWRhdG9yc0ZvcktleShrZXksIHRoaXMuc2NoZW1hW2tleV0sIG9wdGlvbnMsIG9iamVjdCkpXG4gICAgICAgICAgICAgICAgdmFsaWRhdG9yc1trZXldID0ga2V5VmFsaWRhdG9yc1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiB2YWxpZGF0b3JzXG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfZ2V0VmFsaWRhdG9yc0ZvcktleShrZXk6IGFueSwgb2JqZWN0PzogYW55LCBvcHRpb25zPzogVmFsaWRhdGlvbk9wdGlvbnMpOiBhbnkge1xuICAgICAgICBvcHRpb25zID0gdHlwZW9mIG9wdGlvbnMgPT09ICdvYmplY3QnID8gXy5kZWZhdWx0cyhvcHRpb25zLCB0aGlzLm9wdGlvbnMpIDogdGhpcy5vcHRpb25zXG4gICAgICAgIHJldHVybiBSb290VmFsaWRhdG9yLmdldFZhbGlkYXRvcnNGb3JLZXkoa2V5LCB0aGlzLnNjaGVtYVtrZXldLCBvcHRpb25zLCBvYmplY3QpXG4gICAgfVxuXG4gICAgcHVibGljIGdldFZhbGlkYXRvcnMoa2V5PzogYW55LCBvYmplY3Q/OiBhbnksIG9wdGlvbnM/OiBWYWxpZGF0aW9uT3B0aW9ucyk6IGFueSB7XG4gICAgICAgIGlmICh0eXBlb2Yga2V5ID09PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2dldFZhbGlkYXRvcnNGb3JLZXkoa2V5LCBvYmplY3QsIG9wdGlvbnMpXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5fZ2V0VmFsaWRhdG9ycyhrZXksIG9iamVjdClcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgX2dldFZhbGlkYXRvckZvcktleShwcm9wZXJ0eTogc3RyaW5nLCBvYmplY3Q/OiBhbnksIG9wdGlvbnM/OiBWYWxpZGF0aW9uT3B0aW9ucyk6IGFueSB7XG4gICAgICAgIGNvbnN0IHZhbGlkYXRvcnMgPSB0aGlzLmdldFZhbGlkYXRvcnMob2JqZWN0LCBvcHRpb25zKVxuXG4gICAgICAgIHJldHVybiAodmFsdWU6IGFueSwgb2JqZWN0PzogYW55LCBvcHRpb25zPzogVmFsaWRhdGlvbk9wdGlvbnMpID0+IHtcbiAgICAgICAgICAgIG9iamVjdCA9IG9iamVjdCA/IG9iamVjdCA6IHZhbHVlXG4gICAgICAgICAgICBjb25zdCByZXN1bHQgPSBuZXcgQ29tcG9zZWRWYWxpZGF0aW9uUmVzdWx0KClcbiAgICAgICAgICAgIGlmICh2YWxpZGF0b3JzLmhhc093blByb3BlcnR5KHByb3BlcnR5KSkge1xuICAgICAgICAgICAgICAgIGNvbnN0IHByb3BlcnR5VmFsaWRhdG9ycyA9IHZhbGlkYXRvcnNbcHJvcGVydHldXG5cbiAgICAgICAgICAgICAgICBmb3IgKGxldCBydWxlIGluIHByb3BlcnR5VmFsaWRhdG9ycykge1xuICAgICAgICAgICAgICAgICAgICBpZiAocHJvcGVydHlWYWxpZGF0b3JzLmhhc093blByb3BlcnR5KHJ1bGUpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB2YWxpZGF0b3IgPSBwcm9wZXJ0eVZhbGlkYXRvcnNbcnVsZV1cbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGVycm9yID0gdmFsaWRhdG9yKHZhbHVlW3Byb3BlcnR5XSwgb2JqZWN0LCBvcHRpb25zKVxuXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGVycm9yID09PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC5hbmQoe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm9wZXJ0eTogcHJvcGVydHksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJ1bGU6IHJ1bGUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IGVycm9yXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGVycm9yID09PSAnb2JqZWN0Jykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC5hbmQoZXJyb3IpXG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gcmVzdWx0LmlzVmFsaWQoKSA/IG51bGwgOiByZXN1bHRcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgX2dldFZhbGlkYXRvcihvYmplY3Q/OiBhbnksIG9wdGlvbnM/OiBWYWxpZGF0aW9uT3B0aW9ucyk6IGFueSB7XG4gICAgICAgIGNvbnN0IHZhbGlkYXRvcnMgPSB0aGlzLmdldFZhbGlkYXRvcnMob2JqZWN0LCBvcHRpb25zKVxuXG4gICAgICAgIHJldHVybiAodmFsdWU6IGFueSwgb2JqZWN0PzogYW55LCBvcHRpb25zPzogVmFsaWRhdGlvbk9wdGlvbnMpID0+IHtcbiAgICAgICAgICAgIG9iamVjdCA9IG9iamVjdCA/IG9iamVjdCA6IHZhbHVlXG4gICAgICAgICAgICBjb25zdCByZXN1bHQgPSBuZXcgQ29tcG9zZWRWYWxpZGF0aW9uUmVzdWx0KClcbiAgICAgICAgICAgIGZvciAobGV0IHByb3BlcnR5IGluIHZhbGlkYXRvcnMpIHtcbiAgICAgICAgICAgICAgICBpZiAodmFsaWRhdG9ycy5oYXNPd25Qcm9wZXJ0eShwcm9wZXJ0eSkpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcHJvcGVydHlWYWxpZGF0b3JzID0gdmFsaWRhdG9yc1twcm9wZXJ0eV1cblxuICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBydWxlIGluIHByb3BlcnR5VmFsaWRhdG9ycykge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHByb3BlcnR5VmFsaWRhdG9ycy5oYXNPd25Qcm9wZXJ0eShydWxlKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHZhbGlkYXRvciA9IHByb3BlcnR5VmFsaWRhdG9yc1tydWxlXVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGVycm9yID0gdmFsaWRhdG9yKHZhbHVlW3Byb3BlcnR5XSwgb2JqZWN0LCBvcHRpb25zKVxuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBlcnJvciA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0LmFuZCh7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm9wZXJ0eTogcHJvcGVydHksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBydWxlOiBydWxlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZTogZXJyb3JcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBlcnJvciA9PT0gJ29iamVjdCcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0LmFuZChlcnJvcilcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gcmVzdWx0LmlzVmFsaWQoKSA/IG51bGwgOiByZXN1bHRcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyBnZXRWYWxpZGF0b3Ioa2V5PzogYW55LCBvYmplY3Q/OiBhbnksIG9wdGlvbnM/OiBWYWxpZGF0aW9uT3B0aW9ucyk6IGFueSB7XG4gICAgICAgIGlmICh0eXBlb2Yga2V5ID09PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2dldFZhbGlkYXRvckZvcktleShrZXksIG9iamVjdCwgb3B0aW9ucylcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLl9nZXRWYWxpZGF0b3Ioa2V5LCBvYmplY3QpXG4gICAgICAgIH1cbiAgICB9XG59XG4iXX0=
